<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Checkout - LoveMeNow</title>

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

  <!-- Stripe.js -->
  <script src="https://js.stripe.com/v3/" nonce="{{ csp_nonce() }}"></script>

  <!-- Site CSS -->
  <link rel="stylesheet" href="{{ url_for('static', filename='CSS/styles.css') }}">

  <!-- Mobile Optimizations CSS -->
  <link rel="preload" href="{{ url_for('static', filename='CSS/mobile-optimizations.css') }}" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <noscript><link rel="stylesheet" href="{{ url_for('static', filename='CSS/mobile-optimizations.css') }}"></noscript>

  <!-- CSRF -->
  {% include 'csrf_meta.html' %}

  <style>
    .checkout-container{max-width:1400px;margin:2rem auto;padding:0 1rem}
    .checkout-header{text-align:center;margin-bottom:2rem}
    .checkout-header h1{font-size:2rem;margin-bottom:.5rem;background:linear-gradient(135deg,hsl(var(--primary-color)),hsl(var(--accent-color)));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .checkout-layout{display:grid;grid-template-columns:1fr 500px;gap:3rem;align-items:start}
    .checkout-form{background:hsl(var(--surface-color));border-radius:var(--radius-lg);padding:2rem;box-shadow:var(--shadow-lg);border:1px solid hsl(var(--border-color))}
    .form-section{margin-bottom:1.5rem}
    .form-section h3{margin-bottom:.75rem;color:hsl(var(--text-color));font-size:1.1rem;border-bottom:1px solid hsl(var(--primary-color));padding-bottom:.4rem;font-weight:600}
    .delivery-options{display:grid;grid-template-columns:1fr 1fr;gap:.75rem;margin-bottom:1rem}
    .delivery-option{padding:.75rem;border:1px solid hsl(var(--border-color));border-radius:var(--radius-md);cursor:pointer;transition:all .2s ease;background:hsl(var(--background-color));text-align:center}
    .delivery-option:hover{border-color:hsl(var(--primary-color));transform:translateY(-2px);box-shadow:var(--shadow-md)}
    .delivery-option.active{border-color:hsl(var(--primary-color));background:hsla(var(--primary-color),.1);transform:translateY(-2px);box-shadow:var(--shadow-md)}
    .delivery-option i{font-size:1.5rem;margin-bottom:.5rem;color:hsl(var(--muted-color))}
    .delivery-option.active i{color:hsl(var(--primary-color))}
    .delivery-option-title{font-weight:600;margin-bottom:.25rem;color:hsl(var(--text-color))}
    .delivery-option.active .delivery-option-title{color:hsl(var(--primary-color))}
    .delivery-option-desc{font-size:.9rem;color:hsl(var(--muted-color))}
    #get-quote-btn{background:hsl(var(--primary-color));color:#fff;border:0;padding:.5rem 1rem;border-radius:6px;cursor:pointer;font-weight:600;transition:all .2s ease;margin-top:10px}
    #get-quote-btn:hover{background:hsl(var(--primary-color) / .8);transform:translateY(-1px)}
    #get-quote-btn:disabled{opacity:.6;cursor:not-allowed;transform:none}
    .form-group{margin-bottom:.75rem}
    .form-row{display:grid;grid-template-columns:1fr 1fr;gap:1rem}
    label{display:block;margin-bottom:.5rem;font-weight:600;color:hsl(var(--text-color))}
    input,select{width:100%;padding:.75rem;border:2px solid hsl(var(--border-color));border-radius:var(--radius-md);font-size:1rem;transition:all .2s ease;background:hsl(var(--background-color));color:hsl(var(--text-color))}
    input:focus,select:focus{outline:0;border-color:hsl(var(--primary-color));box-shadow:0 0 0 3px hsla(var(--primary-color),.1)}
    .order-summary{background:hsl(var(--surface-color));border-radius:var(--radius-lg);padding:2rem;height:fit-content;position:sticky;top:2rem;box-shadow:var(--shadow-lg);border:1px solid hsl(var(--border-color))}
    .order-summary h3{margin-bottom:1.5rem;color:hsl(var(--text-color));border-bottom:2px solid hsl(var(--primary-color));padding-bottom:.5rem;font-weight:700}
    .order-item{display:flex;justify-content:space-between;align-items:center;padding:1rem 0;border-bottom:1px solid hsl(var(--border-color))}
    .item-details{flex:1}
    .item-name{font-weight:600;margin-bottom:.25rem;color:hsl(var(--text-color))}
    .item-quantity{color:hsl(var(--muted-color));font-size:.9rem}
    .item-price{font-weight:600;color:hsl(var(--text-color))}
    .summary-row{display:flex;justify-content:space-between;margin-bottom:1rem;padding-bottom:1rem;color:hsl(var(--text-color))}
    .summary-row.total{border-top:2px solid hsl(var(--border-color));padding-top:1rem;font-weight:600;font-size:1.2rem;color:hsl(var(--text-color))}
    .checkout-btn{width:100%;padding:1rem;background:linear-gradient(135deg,hsl(var(--primary-color)),hsl(var(--accent-color)));color:#fff;border:0;border-radius:var(--radius-md);font-weight:600;font-size:1.1rem;cursor:pointer;transition:all .2s ease;margin-top:1rem}
    .checkout-btn:hover{transform:translateY(-2px);box-shadow:var(--shadow-lg)}
    .checkout-btn:disabled{opacity:.6;cursor:not-allowed;transform:none}
    .loading-spinner{display:none;margin-right:.5rem}
    .error-message{background:hsl(var(--error-bg,354 70% 94%));color:hsl(var(--error-text,354 70% 25%));padding:1rem;border-radius:var(--radius-md);margin-bottom:1rem;border:1px solid hsl(var(--error-border,354 70% 85%))}
    .success-message{background:hsl(var(--success-bg,142 76% 94%));color:hsl(var(--success-text,142 76% 25%));padding:1rem;border-radius:var(--radius-md);margin-bottom:1rem;border:1px solid hsl(var(--success-border,142 76% 85%))}
    #stripe-checkout{min-height:200px;padding:1rem;border:2px solid hsl(var(--border-color));border-radius:var(--radius-md);background:hsl(var(--background-color))}
    input[readonly]{background:#f8f9fa!important;color:#6c757d!important;cursor:not-allowed!important;border-color:#e9ecef!important}
    input[readonly]:focus{box-shadow:none!important;border-color:#e9ecef!important}
    @media (max-width:1024px){.checkout-layout{grid-template-columns:1fr;gap:2rem}.delivery-options{grid-template-columns:1fr}.form-row{grid-template-columns:1fr}}
  </style>
</head>
<body>
  {% include "navbar.html" %}

  <div class="checkout-container">
    <div class="checkout-header">
      <h1>Secure Checkout</h1>
      <p>Complete your order with our secure payment system</p>
    </div>

    <div class="checkout-layout">
      <!-- Checkout Form -->
      <div class="checkout-form">
        <!-- Delivery Options -->
        <div class="form-section">
          <h3><i class="fas fa-truck"></i> Delivery Options</h3>
          <div class="delivery-options">
            <div class="delivery-option" data-type="pickup">
              <i class="fas fa-store"></i>
              <div class="delivery-option-title">Store Pickup</div>
              <div class="delivery-option-desc">Free pickup at our Miami location</div>
            </div>
            <div class="delivery-option" data-type="delivery">
              <i class="fas fa-shipping-fast"></i>
              <div class="delivery-option-title">Uber Delivery</div>
              <div class="delivery-option-desc">Fast delivery to your door</div>
            </div>
          </div>
        </div>

        <!-- Contact -->
        <div class="form-section">
          <h3><i class="fas fa-user"></i> Contact Information</h3>

          {% if user_data %}
            <div class="form-group">
              <label for="email">Email Address</label>
              <input type="email" id="email" name="email" value="{{ user_data.email }}" readonly>
            </div>
            <div class="form-group">
              <label for="fullName">Full Name</label>
              <input type="text" id="fullName" name="fullName" value="{{ user_data.full_name }}" readonly>
            </div>
            <div class="form-group">
              <label for="phone">Phone Number</label>
              <input type="tel" id="phone" name="phone" required placeholder="Enter your phone number">
            </div>
          {% else %}
            <div class="form-group">
              <label for="email">Email Address</label>
              <input type="email" id="email" name="email" required>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="firstName">First Name</label>
                <input type="text" id="firstName" name="firstName" required>
              </div>
              <div class="form-group">
                <label for="lastName">Last Name</label>
                <input type="text" id="lastName" name="lastName" required>
              </div>
            </div>
            <div class="form-group">
              <label for="phone">Phone Number</label>
              <input type="tel" id="phone" name="phone" required>
            </div>
          {% endif %}
        </div>

        <!-- Delivery Address (only for delivery) -->
        <div class="form-section" id="delivery-address-section" style="display:none;">
          <h3><i class="fas fa-map-marker-alt"></i> Delivery Address</h3>

          {% if user_data and user_addresses %}
            <div class="form-group">
              <label for="saved-address">Use Saved Address</label>
              <select id="saved-address" name="saved-address">
                <option value="">Select a saved address</option>
                {% for address in user_addresses %}
                  <option value="{{ address.id }}"
                          data-address="{{ address.address }}"
                          data-suite="{{ address.suite or '' }}"
                          data-city="{{ address.city }}"
                          data-state="{{ address.state }}"
                          data-zip="{{ address.zip }}"
                          {% if address.is_default %}selected{% endif %}>
                    {{ address.address }}{% if address.suite %}, {{ address.suite }}{% endif %}, {{ address.city }}, {{ address.state }} {{ address.zip }}{% if address.is_default %} (Default){% endif %}
                  </option>
                {% endfor %}
                <option value="manual">Enter new address manually</option>
              </select>
            </div>
            <div id="manual-address-fields" {% if default_address %}style="display:none"{% endif %}>
          {% else %}
            <div id="manual-address-fields">
          {% endif %}
              <div class="form-group">
                <label for="address">Street Address</label>
                <input type="text" id="address" name="address"{% if default_address %} value="{{ default_address.address }}"{% endif %}>
              </div>
              <div class="form-group">
                <label for="suite">Apartment/Suite (Optional)</label>
                <input type="text" id="suite" name="suite"{% if default_address %} value="{{ default_address.suite or '' }}"{% endif %}>
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label for="city">City</label>
                  <input type="text" id="city" name="city" value="{% if default_address %}{{ default_address.city }}{% else %}Miami{% endif %}">
                </div>
                <div class="form-group">
                  <label for="state">State</label>
                  <select id="state" name="state">
                    <option value="FL" {% if not default_address or default_address.state == 'FL' %}selected{% endif %}>Florida</option>
                  </select>
                </div>
              </div>
              <div class="form-group">
                <label for="zip">ZIP Code</label>
                <input type="text" id="zip" name="zip"{% if default_address %} value="{{ default_address.zip }}"{% endif %}>
              </div>
            </div>

          <div id="delivery-error-message" class="error-message" style="display:none;">
            <i class="fas fa-exclamation-triangle"></i>
            <span id="delivery-error-text"></span>
          </div>
        </div>

        <!-- Payment -->
        <div class="form-section">
          <h3><i class="fas fa-credit-card"></i> Payment Information</h3>
          <div id="stripe-checkout"></div>
        </div>

        <div id="error-message" class="error-message" style="display:none;"></div>
        <div id="success-message" class="success-message" style="display:none;"></div>
      </div>

      <!-- Order Summary -->
      <div class="order-summary">
        <h3>Order Summary</h3>

        <div id="cart-items"></div>

        <div class="summary-row">
          <span>Subtotal:</span>
          <span id="subtotal">$0.00</span>
        </div>

        <div class="summary-row" id="discount-row" style="display:none;">
          <span>Discount <span id="discount-code-label"></span>:</span>
          <span id="discount-amount">-$0.00</span>
        </div>

        <div class="summary-row" id="delivery-fee-row" style="display:none;">
          <span>Delivery Fee:</span>
          <span id="delivery-fee">$0.00</span>
        </div>

        <div class="summary-row">
          <span>Tax (8.75%):</span>
          <span id="tax-amount">$0.00</span>
        </div>

        <div class="summary-row total">
          <span>Total:</span>
          <span id="total">$0.00</span>
        </div>

        <div id="checkout-status" class="checkout-status" style="text-align:center;margin-bottom:1rem;color:#666;font-size:.9rem;">
          Please select a delivery option to continue
        </div>

        <button id="checkout-button" class="checkout-btn" disabled>
          <i class="loading-spinner fas fa-spinner fa-spin"></i>
          Complete Order
        </button>
      </div>
    </div>
  </div>

  {% include "footer.html" %}

  <!-- Bootstrap data for checkout.js (no business logic here) -->
  <script id="checkout-bootstrap" type="application/json">
    {
      "cart": {{ cart_data | tojson }},
      "stripePublishableKey": "{{ config.STRIPE_PUBLISHABLE_KEY }}",
      "defaultDeliveryType": "pickup"
    }
  </script>

  <!-- App JS -->
<script src="{{ url_for('static', filename='js/mobile-menu.js') }}?v=20250929-1" defer></script>
<script src="{{ url_for('static', filename='js/checkout.js') }}?v=20250929-2" defer></script>
</body>
</html>
