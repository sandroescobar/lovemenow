
<!-- Change Password Modal -->
<div class="modal-overlay hidden" id="changePasswordModal">
    <div class="modal">
        <div class="modal-header">
            <button class="modal-close" type="button" aria-label="Close modal">
                <i class="fas fa-times"></i>
            </button>
            <h2 class="modal-title">
                <i class="fas fa-key"></i>
                Change Password
            </h2>
            <p class="modal-subtitle">Update your account security</p>
        </div>
        <div class="modal-body">
            <div class="error-message" id="passwordError" style="display: none;"></div>
            <div class="success-message" id="passwordSuccess" style="display: none;"></div>
            <form class="auth-form" id="changePasswordForm" method="POST" action="{{ url_for('auth.change_password') }}">
                <!-- <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/> -->
                <div class="form-group">
                    <label class="form-label" for="currentPassword">Current Password</label>
                    <div class="input-group">
                        <i class="fas fa-lock"></i>
                        <input name="current_password" type="password" id="currentPassword" class="form-control" placeholder="Enter your current password" required autocomplete="current-password">
                        <i class="fas fa-eye-slash password-toggle" role="button" tabindex="0" aria-label="Toggle password visibility"></i>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label" for="newPassword">New Password</label>
                    <div class="input-group">
                        <i class="fas fa-lock"></i>
                        <input name="new_password" type="password" id="newPassword" class="form-control" placeholder="Enter your new password" required autocomplete="new-password">
                        <i class="fas fa-eye-slash password-toggle" role="button" tabindex="0" aria-label="Toggle password visibility"></i>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label" for="confirmNewPassword">Confirm New Password</label>
                    <div class="input-group">
                        <i class="fas fa-lock"></i>
                        <input name="confirm_password" type="password" id="confirmNewPassword" class="form-control" placeholder="Confirm your new password" required autocomplete="new-password">
                        <i class="fas fa-eye-slash password-toggle" role="button" tabindex="0" aria-label="Toggle password visibility"></i>
                    </div>
                </div>

                <div class="password-modal-actions">
                    <button type="submit" class="auth-submit">
                        <i class="fas fa-shield-alt"></i>
                        Update Password
                    </button>
                    <button type="button" class="btn-cancel" onclick="closePasswordModal()">
                        <i class="fas fa-times"></i>
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

{% include "logged_in_modal.html" %}

<script>
// Change password modal functionality
document.addEventListener('DOMContentLoaded', function () {
  const modal = document.getElementById('changePasswordModal');
  const form  = document.getElementById('changePasswordForm');
  const closeButtons = modal.querySelectorAll('.modal-close, .btn-cancel');

  // Submit -> AJAX handler
  if (form) {
    form.addEventListener('submit', function (e) {
      e.preventDefault();
      handlePasswordChange();
    });
  }

  // Close buttons
  closeButtons.forEach(btn => btn.addEventListener('click', closePasswordModal));

  // Click outside to close
  modal.addEventListener('click', e => { if (e.target === modal) closePasswordModal(); });

  // âœ… Password toggles (fix: use the element itself as the icon)
  const toggles = modal.querySelectorAll('.password-toggle');
  toggles.forEach(icon => {
    const input = icon.parentElement.querySelector('input');
    if (!input) return;

    function flip() {
      const show = input.type === 'password';
      input.type = show ? 'text' : 'password';
      icon.classList.toggle('fa-eye', show);
      icon.classList.toggle('fa-eye-slash', !show);
      icon.setAttribute('aria-label', show ? 'Hide password' : 'Show password');
      icon.setAttribute('aria-pressed', show ? 'true' : 'false');
    }

    icon.addEventListener('click', flip);
    icon.addEventListener('keydown', e => {
      if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); flip(); }
    });
  });
});

function handlePasswordChange() {
  const form = document.getElementById('changePasswordForm');
  const fd = new FormData(form);

  const currentPassword = fd.get('current_password');
  const newPassword     = fd.get('new_password');
  const confirmPassword = fd.get('confirm_password');

  clearPasswordMessages();

  if (newPassword !== confirmPassword) return showPasswordError('New passwords do not match');
  if (newPassword.length < 8)          return showPasswordError('New password must be at least 8 characters long');

  fetch('/auth/change-password', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ current_password: currentPassword, new_password: newPassword })
  })
  .then(r => r.json())
  .then(data => {
    if (data?.message) {
      showPasswordSuccess(data.message);
      setTimeout(closePasswordModal, 2000);
    } else {
      showPasswordError(data?.error || 'Failed to change password');
    }
  })
  .catch(() => showPasswordError('Network error. Please try again.'));
}

function showPasswordError(msg){ const el = document.getElementById('passwordError'); if (el){ el.textContent = msg; el.style.display = 'block'; } }
function showPasswordSuccess(msg){ const el = document.getElementById('passwordSuccess'); if (el){ el.textContent = msg; el.style.display = 'block'; } }
function clearPasswordMessages(){ ['passwordError','passwordSuccess'].forEach(id => { const el = document.getElementById(id); if (el){ el.style.display='none'; el.textContent=''; } }); }
</script>


<script src="{{ url_for('static', filename='js/index.js') }}"></script>
