
<!-- Change Password Modal -->
<div class="modal-overlay hidden" id="changePasswordModal">
    <div class="modal">
        <div class="modal-header">
            <button class="modal-close" type="button" aria-label="Close modal">
                <i class="fas fa-times"></i>
            </button>
            <h2 class="modal-title">
                <i class="fas fa-key"></i>
                Change Password
            </h2>
            <p class="modal-subtitle">Update your account security</p>
        </div>
        <div class="modal-body">
            <div class="error-message" id="passwordError" style="display: none;"></div>
            <div class="success-message" id="passwordSuccess" style="display: none;"></div>
            <form class="auth-form" id="changePasswordForm" method="POST" action="{{ url_for('auth.change_password') }}">
                <!-- <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/> -->
                <div class="form-group">
                    <label class="form-label" for="currentPassword">Current Password</label>
                    <div class="input-group">
                        <i class="fas fa-lock"></i>
                        <input name="current_password" type="password" id="currentPassword" class="form-control" placeholder="Enter your current password" required autocomplete="current-password">
                        <i class="fas fa-eye-slash password-toggle" role="button" tabindex="0" aria-label="Toggle password visibility"></i>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label" for="newPassword">New Password</label>
                    <div class="input-group">
                        <i class="fas fa-lock"></i>
                        <input name="new_password" type="password" id="newPassword" class="form-control" placeholder="Enter your new password" required autocomplete="new-password">
                        <i class="fas fa-eye-slash password-toggle" role="button" tabindex="0" aria-label="Toggle password visibility"></i>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label" for="confirmNewPassword">Confirm New Password</label>
                    <div class="input-group">
                        <i class="fas fa-lock"></i>
                        <input name="confirm_password" type="password" id="confirmNewPassword" class="form-control" placeholder="Confirm your new password" required autocomplete="new-password">
                        <i class="fas fa-eye-slash password-toggle" role="button" tabindex="0" aria-label="Toggle password visibility"></i>
                    </div>
                </div>

                <div class="password-modal-actions">
                    <button type="submit" class="auth-submit">
                        <i class="fas fa-shield-alt"></i>
                        Update Password
                    </button>
                    <button type="button" class="btn-cancel" onclick="closePasswordModal()">
                        <i class="fas fa-times"></i>
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Change password modal functionality
document.addEventListener('DOMContentLoaded', function() {
    const changePasswordForm = document.getElementById('changePasswordForm');
    const modal = document.getElementById('changePasswordModal');
    const closeButtons = modal.querySelectorAll('.modal-close, .btn-cancel');
    
    // Handle form submission
    if (changePasswordForm) {
        changePasswordForm.addEventListener('submit', function(e) {
            e.preventDefault();
            handlePasswordChange();
        });
    }
    
    // Handle close buttons
    closeButtons.forEach(button => {
        button.addEventListener('click', function() {
            closePasswordModal();
        });
    });
    
    // Handle overlay click
    if (modal) {
        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                closePasswordModal();
            }
        });
    }
    
    // Handle password toggle functionality
    const passwordToggles = modal.querySelectorAll('.password-toggle');
    passwordToggles.forEach(toggle => {
        toggle.addEventListener('click', function() {
            const input = this.parentElement.querySelector('input');
            const icon = this.querySelector('i');
            
            if (input.type === 'password') {
                input.type = 'text';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            } else {
                input.type = 'password';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            }
        });
    });
});

function handlePasswordChange() {
    const form = document.getElementById('changePasswordForm');
    const formData = new FormData(form);
    
    // Get form values
    const currentPassword = formData.get('current_password');
    const newPassword = formData.get('new_password');
    const confirmPassword = formData.get('confirm_password');
    
    // Clear previous messages
    clearPasswordMessages();
    
    // Validate passwords match
    if (newPassword !== confirmPassword) {
        showPasswordError('New passwords do not match');
        return;
    }
    
    // Validate password length
    if (newPassword.length < 8) {
        showPasswordError('New password must be at least 8 characters long');
        return;
    }
    
    // Send request
    fetch('/auth/change-password', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            current_password: currentPassword,
            new_password: newPassword
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.message) {
            showPasswordSuccess(data.message);
            // Close modal after success
            setTimeout(() => {
                closePasswordModal();
            }, 2000);
        } else {
            showPasswordError(data.error || 'Failed to change password');
        }
    })
    .catch(error => {
        showPasswordError('Network error. Please try again.');
    });
}

function showPasswordError(message) {
    const errorElement = document.getElementById('passwordError');
    if (errorElement) {
        errorElement.textContent = message;
        errorElement.style.display = 'block';
    }
}

function showPasswordSuccess(message) {
    const successElement = document.getElementById('passwordSuccess');
    if (successElement) {
        successElement.textContent = message;
        successElement.style.display = 'block';
    }
}

function clearPasswordMessages() {
    const errorElement = document.getElementById('passwordError');
    const successElement = document.getElementById('passwordSuccess');
    
    if (errorElement) {
        errorElement.style.display = 'none';
        errorElement.textContent = '';
    }
    
    if (successElement) {
        successElement.style.display = 'none';
        successElement.textContent = '';
    }
}
</script>

<script src="{{ url_for('static', filename='js/index.js') }}"></script>
