<!DOCTYPE html>
<html lang="en">
<head>
  <!-- localStorage Cleanup - Prevent stale data from affecting Lighthouse tests -->
  <script>
    (function() {
      try {
        // Clear stale localStorage data that accumulates over time
        const now = Date.now();
        const maxAge = 7 * 24 * 60 * 60 * 1000; // 7 days
        
        // Get and validate stored timestamp
        const timestamp = localStorage.getItem('lmn_cleanup_ts');
        const lastCleanup = timestamp ? parseInt(timestamp) : 0;
        
        // Only run cleanup every 24 hours to avoid frequent operations
        if (now - lastCleanup > 24 * 60 * 60 * 1000) {
          // Clear promo data if present (can be regenerated)
          localStorage.removeItem('promoModalShown');
          localStorage.removeItem('promoCode');
          
          // Reset cart count if it seems corrupted (e.g., negative values)
          const cartCount = localStorage.getItem('cartCount');
          if (cartCount && (parseInt(cartCount) < 0 || parseInt(cartCount) > 999)) {
            localStorage.removeItem('cartCount');
          }
          
          // Update cleanup timestamp
          localStorage.setItem('lmn_cleanup_ts', now.toString());
        }
      } catch(e) {
        // Silently ignore localStorage errors (e.g., in private/incognito mode)
      }
    })();
  </script>

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <meta name="description" content="Browse our complete collection of premium adult products with same-day delivery in Miami â€“ vibrators, dildos, couples kits, and more at LoveMeNow" />
  <title>Adult Products Miami â€“ Same-Day Delivery | LoveMeNow</title>

  <!-- Open Graph -->
  <meta property="og:type" content="website"/>
  <meta property="og:title" content="Adult Products Miami â€“ Same-Day Delivery | LoveMeNow"/>
  <meta property="og:description" content="Browse vibrators, dildos, couples kits, and more. Same-day discreet delivery in Miami."/>
  <meta property="og:url" content="https://lovemenowmiami.com/products"/>
  <meta property="og:site_name" content="LoveMeNow Miami"/>
  <link rel="canonical" href="{{ url_for('main.products', _external=True) }}">

  {# --- Preload the first visible product image for faster LCP --- #}
  {% if products.items|length %}
    {% set p0 = products.items[0] %}
    {% if p0.variants|length > 1 and p0.default_variant %}
      {% set imgs = p0.default_variant.images|map(attribute='url')|list %}
      {% if not imgs and p0.image_url %}
        {% set imgs = [p0.image_url] %}
      {% endif %}
    {% else %}
      {% set imgs = p0.all_image_urls %}
      {% if not imgs and p0.image_url %}
        {% set imgs = [p0.image_url] %}
      {% endif %}
    {% endif %}
    {% if imgs and imgs|length %}
      {% set full_url = imgs[0] if imgs[0].startswith('http') or imgs[0].startswith('/static/') else url_for('static', filename=imgs[0].lstrip('/')) %}
      {% set webp_url = full_url.replace('.png', '__alpha.webp').replace('.jpg', '__alpha.webp').replace('.jpeg', '__alpha.webp') if full_url.endswith(('.png', '.jpg', '.jpeg')) else full_url %}
      <link rel="preload" as="image" href="{{ webp_url }}" fetchpriority="high">
    {% endif %}
  {% endif %}

  <!-- Favicon -->
  <link rel="icon" href="{{ url_for('static', filename='IMG/icons/favicon.ico') }}" type="image/x-icon">

  <!-- Fonts / Icons -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preload" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <noscript><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"></noscript>

  <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <noscript><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"></noscript>

  <!-- Critical CSS inline for LCP optimization -->
  <style>
    :root{--primary:278 82% 52%;--accent:291 64% 42%;--text:240 10% 20%;--muted:240 5% 50%;--surface:240 5% 97%;--bg:240 10% 95%;--border:240 5% 90%}
    *{margin:0;padding:0;box-sizing:border-box}
    html{scroll-behavior:smooth;background:hsl(var(--bg))}
    body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;line-height:1.6;color:hsl(var(--text));text-rendering:optimizeLegibility;-webkit-font-smoothing:antialiased}
    .product-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:1.5rem;padding:1.5rem}
    .product-card{background:hsl(var(--surface));border-radius:8px;overflow:hidden;transition:transform .2s}
    .product-card-image{position:relative;width:100%;padding-bottom:100%;background:hsl(var(--bg));overflow:hidden}
    .product-slide{position:absolute;top:0;left:0;width:100%;height:100%;object-fit:contain;opacity:0;transition:opacity .3s;display:none}
    .product-slide.active{opacity:1;display:block}
    picture{display:contents}
    .product-info{padding:1rem}
    .product-title{font-size:.95rem;font-weight:600;line-height:1.2;margin:.5rem 0}
    .product-price{font-size:1.1rem;color:hsl(var(--primary));font-weight:700}
  </style>

  <!-- Non-critical CSS - load async -->
  <link rel="preload" href="{{ url_for('static', filename='CSS/styles.css') }}?v=20250116-4" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <noscript><link rel="stylesheet" href="{{ url_for('static', filename='CSS/styles.css') }}?v=20250116-4"></noscript>

  <link rel="preload" href="{{ url_for('static', filename='CSS/mobile-optimizations.css') }}?v=20250116-3" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <noscript><link rel="stylesheet" href="{{ url_for('static', filename='CSS/mobile-optimizations.css') }}?v=20250116-3"></noscript>

  <!-- Mobile filter sheet styles -->
  <link rel="preload" href="{{ url_for('static', filename='CSS/filters-sheet.css') }}?v=20251004-2" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <noscript><link rel="stylesheet" href="{{ url_for('static', filename='CSS/filters-sheet.css') }}?v=20251004-2"></noscript>

   <link rel="stylesheet" href="{{ url_for('static', filename='CSS/overrides.css') }}?v=20251104-2">

  <!-- Safari Fixes CSS -->
  <link rel="stylesheet" href="{{ url_for('static', filename='CSS/safari-fixes.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='CSS/filter-bar-v2.css') }}?v=20260218">


  <!-- CSRF + Tags -->
  {% include 'csrf_meta.html' %}
  {% include 'google_tag_head.html' %}

  <!-- Toast styles (kept local) -->
  <style>
    .toast-stack{position:fixed;top:16px;right:16px;display:flex;flex-direction:column;gap:10px;z-index:2147483647;pointer-events:none}
    .toast,.flash-message,.notification{pointer-events:auto;display:flex;align-items:flex-start;gap:12px;min-width:260px;max-width:460px;background:#111;color:#fff;border-radius:12px;padding:12px 14px;box-shadow:0 8px 30px rgba(0,0,0,.25);font:500 14px/1.35 Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    .toast.success,.flash-message.success{background:#10b981!important;box-shadow:0 4px 12px rgba(16,185,129,.35)!important}
    .toast.error,.flash-message.error{background:#dc2626}
    .toast.info,.flash-message.info{background:#3b82f6}
    .toast .msg,.flash-message .msg{flex:1 1 auto}
    .toast .close,.flash-message .close,[data-close]{margin-left:auto;border:0;background:transparent;color:inherit;font-size:16px;cursor:pointer;opacity:.85}
    .toast.fade-out,.flash-message.fade-out,.notification.fade-out{opacity:0;transform:translateY(-6px);transition:opacity .25s ease,transform .25s ease}
  </style>
</head>
<body>
  {% include 'google_tag_body.html' %}
  {# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     GLOBAL MACROS
     ----------------------------------------------------------------- #}
  {% macro render_colour_dots(product) -%}
    {% set n = product.colors|length %}
    {% if n == 0 %}
      <span class="colour-unavailable">Colour N/A</span>
    {% elif n == 2 %}
      <span class="color-dot diagonal-split"
            style="background:linear-gradient(135deg,
                   {{ product.colors[0].hex }} 0% 50%,
                   {{ product.colors[1].hex }} 50% 100%);"
            title="{{ product.colors[0].name }} / {{ product.colors[1].name }}"></span>
    {% else %}
      {% set step = 100 // n %}
      {% set stops = [] %}
      {% for c in product.colors %}
        {% set start = loop.index0 * step %}
        {% set end   = loop.index * step %}
        {% set _ = stops.append(c.hex ~ ' ' ~ start ~ '% ' ~ end ~ '%') %}
      {% endfor %}
      <span class="color-dot"
            style="background:linear-gradient(135deg, {{ stops|join(', ') }});"
            title="{{ product.colors|map(attribute='name')|join(' / ') }}"></span>
    {% endif %}
  {%- endmacro %}

  {# â–‘â–‘â–‘ NAVBAR â–‘â–‘â–‘ #}
  {% include "navbar.html" %}

  {# â–‘â–‘â–‘ FILTER NAVBAR â–‘â–‘â–‘ #}
  {% set cur_cat = current_filters.category|default('') %}
  {% set cur_sort = current_filters.sort|default('') if current_filters.sort is defined else '' %}
  <section class="filter-bar-v2">
    <div class="container">

      {# â”€â”€ Row 1: Search â”€â”€ #}
      <div class="fb2-search">
        <div class="fb2-search-inner">
          <i class="fas fa-search fb2-search-icon"></i>
          <input type="text" id="fb2Search" placeholder="Search products..." value="{{ current_filters.search or '' }}">
          <button class="fb2-clear-search" id="fb2ClearSearch" type="button"><i class="fas fa-times"></i></button>
        </div>
      </div>

      {# â”€â”€ Row 2: Category Pills â”€â”€ #}
      <div class="fb2-categories">
        <button class="fb2-pill fb2-cat-pill{{ ' active' if not cur_cat }}" data-category="all" data-label="All">
          <i class="fas fa-th"></i> All
        </button>
        {% set cat_map = {
          'bdsm':                 {'icon':'fa-link',   'label':'Bondage & Kink'},
          'toys':                 {'icon':'fa-star',   'label':'Toys'},
          'lingerie':             {'icon':'fa-tshirt', 'label':'Lingerie'},
          'lubricant':            {'icon':'fa-tint',   'label':'Lubricants'},
          'anal-toys':            {'icon':'__svg_plug', 'label':'Anal Toys'},
          'sexual-enhancements':  {'icon':'fa-pills',  'label':'Sexual Enhancements'},
          'kits':                 {'icon':'fa-heart',  'label':'Couples Kits'}
        } %}
        {% for category in categories %}
          {% set slug = category.slug %}
          {% set info = cat_map.get(slug, {}) %}
          {% set icon = info.get('icon', 'fa-tag') %}
          {% set label = info.get('label', category.name) %}
          <button class="fb2-pill fb2-cat-pill{{ ' active' if cur_cat == slug }}" data-category="{{ slug }}" data-label="{{ label }}">
            {% if icon == '__svg_plug' %}
              <svg class="fb2-plug-icon" width="16" height="18" viewBox="0 0 16 18" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M8 0L12.8 7.5c.8 1.3 1.2 2.5 1.2 3.5 0 2-1.6 3-3.5 3.2v1H10a.7.7 0 0 1 .7.7v.4a.7.7 0 0 1-.7.7H6a.7.7 0 0 1-.7-.7v-.4A.7.7 0 0 1 6 15.2h-.5v-1C3.6 14 2 13 2 11c0-1 .4-2.2 1.2-3.5L8 0z"/><ellipse cx="8" cy="17.2" rx="4.2" ry="1"/></svg>
            {% else %}
              <i class="fas {{ icon }}"></i>
            {% endif %}
            {{ label }}
          </button>
        {% endfor %}

        {# More dropdown â€” subcategories + gender #}
        <div class="fb2-more-wrap">
          <button class="fb2-pill" type="button">
            <i class="fas fa-ellipsis-h"></i> More <i class="fas fa-chevron-down" style="font-size:10px;margin-left:2px;"></i>
          </button>
          <div class="fb2-more-dropdown">
            <div class="fb2-dd-section-title">Gender</div>
            <a class="fb2-dd-item" data-category="men">Men</a>
            <a class="fb2-dd-item" data-category="women">Women</a>
            <div class="fb2-dd-divider"></div>
            {% for category in categories if category.children %}
            <div class="fb2-dd-section-title">{{ cat_map.get(category.slug, {}).get('label', category.name) }}</div>
            {% for sub in category.children %}
            <a class="fb2-dd-item" data-category="{{ sub.slug }}">{{ sub.name }}</a>
            {% endfor %}
            {% if not loop.last %}<div class="fb2-dd-divider"></div>{% endif %}
            {% endfor %}
          </div>
        </div>
      </div>

      {# â”€â”€ Row 3: Filter Controls â”€â”€ #}
      <div class="fb2-filters">
        <button class="fb2-pill fb2-bestseller" id="fb2BestSellers" type="button">
          <i class="fas fa-crown"></i> Best Sellers
        </button>

        <div class="fb2-sort-wrap">
          <button class="fb2-pill" type="button">
            <i class="fas fa-sort"></i> <span id="fb2SortLabel">Sort By</span> <i class="fas fa-chevron-down" style="font-size:10px;margin-left:2px;"></i>
          </button>
          <div class="fb2-sort-dropdown">
            <a class="fb2-dd-item" data-sort="name"><i class="fas fa-sort-alpha-down"></i> Name Aâ€“Z</a>
            <div class="fb2-dd-divider"></div>
            <a class="fb2-dd-item" data-sort="low-high"><i class="fas fa-arrow-down-short-wide"></i> Price Low â†’ High</a>
            <div class="fb2-dd-divider"></div>
            <a class="fb2-dd-item" data-sort="high-low"><i class="fas fa-arrow-up-wide-short"></i> Price High â†’ Low</a>
            <div class="fb2-dd-divider"></div>
            <a class="fb2-dd-item" data-sort="newest"><i class="fas fa-clock"></i> Newest</a>
          </div>
        </div>

        <div class="fb2-price-wrap">
          <button class="fb2-pill" id="fb2PriceBtn" type="button">
            <i class="fas fa-tag"></i>
            <span id="fb2PriceLabel">Price</span>
            <i class="fas fa-chevron-down" style="font-size:11px;"></i>
          </button>
          <div class="fb2-price-dropdown">
            <a class="fb2-dd-item" data-min="" data-max="25"><i class="fas fa-tag"></i> &lt;$25</a>
            <div class="fb2-dd-divider"></div>
            <a class="fb2-dd-item" data-min="25" data-max="50"><i class="fas fa-tags"></i> $25 â€“ $50</a>
            <div class="fb2-dd-divider"></div>
            <a class="fb2-dd-item" data-min="50" data-max="100"><i class="fas fa-coins"></i> $50 â€“ $100</a>
            <div class="fb2-dd-divider"></div>
            <a class="fb2-dd-item" data-min="100" data-max=""><i class="fas fa-gem"></i> $100+</a>
          </div>
        </div>

        <button class="fb2-pill fb2-stock-pill" id="fb2InStock" type="button">
          <span class="fb2-toggle-track"><span class="fb2-toggle-knob"></span></span>
          In Stock
        </button>
      </div>

      {# â”€â”€ Mobile toolbar (visible < 769px) â”€â”€ #}
      <div class="mobile-category-toolbar">
        <div class="mobile-toolbar-top">
          <button class="btn-category-picker" id="openCategorySheet" type="button">
            <span id="mobileCategoryLabel">ðŸ‘† Click to filter/sort</span>
            <i class="fas fa-chevron-right"></i>
          </button>
          <button class="fb2-pill fb2-stock-pill" type="button">
            <span class="fb2-toggle-track"><span class="fb2-toggle-knob"></span></span>
            In Stock
          </button>
        </div>
        <div class="mobile-toolbar-meta">
          <span>{{ products.total }} products found</span>
        </div>
      </div>

      {# â”€â”€ Bottom row: Active filters + Results count â”€â”€ #}
      <div class="fb2-bottom-row">
        <div class="fb2-active-filters" id="fb2ActiveFilters"></div>
        <span class="fb2-results">{{ products.total }} product{{ 's' if products.total != 1 else '' }}</span>
      </div>

    </div>
  </section>

  {# â–‘â–‘â–‘ PRODUCTS GRID â–‘â–‘â–‘ #}
  <section class="products-section">
    <div class="container">
      <div class="product-grid" id="productGrid">
        {% for p in products.items %}
          {% set is_first_card = loop.first %}
        <div class="product-card fade-in-up"
             data-category="{{ p.category.slug|default('uncategorised') }}"
             data-parent-category="{{ p.category.parent.slug if p.category and p.category.parent else (p.category.slug if p.category else 'uncategorised') }}"
             data-price="{{ p.price }}"
             data-rating="{{ p.rating|default(0) }}"
             data-in-stock="{{ (p.default_variant.is_available if p.default_variant else p.is_available)|lower }}"
             data-brand="{{ p.name.split()[0]|lower|replace('!', '')|replace('&', 'and') }}"
             data-colors="{{ p.available_colors|map(attribute='slug')|join(',') }}"
             data-product-id="{{ p.id }}"
             data-default-variant-id="{{ p.default_variant.id if p.default_variant else '' }}"
             data-has-variants="{{ 'true' if p.variants|length > 1 else 'false' }}"
             data-product-quantity="{{ p.quantity_on_hand or 0 }}">

          <!-- IMAGE WITH SLIDESHOW -->
          <div class="product-image product-card-slideshow" data-product-id="{{ p.id }}">
            {% if p.variants|length > 1 and p.default_variant %}
              {% set default_variant_images = p.default_variant.images|map(attribute='url')|list %}
              {% set all_images = default_variant_images %}
              {% if not all_images and p.image_url %}
                {# Fallback: show product.image_url even when variants exist but have no images yet #}
                {% set all_images = [p.image_url] %}
              {% endif %}
            {% else %}
              {% set all_images = p.all_image_urls %}
              {% if not all_images and p.image_url %}
                {# Fallback: show product.image_url if no variant images yet #}
                {% set all_images = [p.image_url] %}
              {% endif %}
            {% endif %}

            {% if all_images %}
              {% for image_url in all_images %}
                {% set full_url = image_url if image_url.startswith('http') or image_url.startswith('/static/') else url_for('static', filename=image_url.lstrip('/')) %}
                {% set webp_url = full_url.replace('.png', '__alpha.webp').replace('.jpg', '__alpha.webp').replace('.jpeg', '__alpha.webp') if full_url.endswith(('.png', '.jpg', '.jpeg')) else full_url %}
                <picture class="product-slide-picture">
                  <source srcset="{{ webp_url }}" type="image/webp">
                  <img
                    class="product-slide {{ 'active' if loop.first else '' }}"
                    src="{{ full_url }}"
                    alt="{{ p.name|e }}"
                    width="480" height="480"
                    style="width:100%;height:90%; margin-top: 6%;object-fit:contain;aspect-ratio:1;"
                    onerror="handleImageError(this)"
                    decoding="async"
                    loading="{{ 'eager' if is_first_card and loop.first else 'lazy' }}"
                    fetchpriority="{{ 'high' if is_first_card and loop.first else 'auto' }}"
                  >
                </picture>
              {% endfor %}
              {% if all_images|length > 1 %}
                <button class="product-card-nav-arrow prev" onclick="navigateProductCardImage({{ p.id }}, -1)" aria-label="Previous image">
                  <i class="fas fa-chevron-left"></i>
                </button>
                <button class="product-card-nav-arrow next" onclick="navigateProductCardImage({{ p.id }}, 1)" aria-label="Next image">
                  <i class="fas fa-chevron-right"></i>
                </button>
                <div class="product-card-image-counter">
                  <span class="current-image">1</span> / <span class="total-images">{{ all_images|length }}</span>
                </div>
              {% endif %}
            {% elif p.main_image_url %}
              {% set webp_main = p.main_image_url.replace('.png', '__alpha.webp').replace('.jpg', '__alpha.webp').replace('.jpeg', '__alpha.webp') if p.main_image_url.endswith(('.png', '.jpg', '.jpeg')) else p.main_image_url %}
              <picture class="product-slide-picture">
                <source srcset="{{ webp_main }}" type="image/webp">
                <img
                  class="product-slide active"
                  src="{{ p.main_image_url }}"
                  alt="{{ p.name|e }}"
                  width="480" height="480"
                  style="width:100%;height:auto;object-fit:contain;aspect-ratio:1;"
                  onerror="handleImageError(this)"
                  decoding="async"
                  loading="{{ 'eager' if is_first_card else 'lazy' }}"
                  fetchpriority="{{ 'high' if is_first_card else 'auto' }}"
                >
              </picture>
            {% else %}
              <div class="placeholder-image">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                  <circle cx="9" cy="9" r="2"></circle>
                  <path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"></path>
                </svg>
              </div>
            {% endif %}
          </div>

          <!-- Wishlist button positioned at top-right -->




          <!-- INFO -->
          <div class="product-info">
            <div class="product-content">
              <div class="product-category">{{ p.category.name if p.category else 'Featured' }}</div>
              <h3 class="product-title">
                <a href="/product/{{ p.id }}">{{ p.name }}</a>
              </h3>
              <div class="product-price">${{ '%.2f'|format(p.price) }}</div>
              
              <!-- Color Variant Selector for Product Cards (only if has variants) -->
              {% if p.variants|length > 1 and p.available_colors %}
              <div class="card-color-selector">
                {% set has_color_variants = p.variants|selectattr('color_id', 'ne', none)|list|length > 0 %}
                {% if has_color_variants %}
                  <div class="card-colors-label">Colors:</div>
                  <div class="card-color-options">
                    {% for color in p.available_colors %}
                      {% set variant_with_color = p.variants|selectattr('color_id', 'equalto', color.id)|first %}
                      {% if variant_with_color %}
                        <button class="card-color-option {{ 'active' if variant_with_color.id == p.default_variant.id else '' }}"
                                data-product-id="{{ p.id }}"
                                data-variant-id="{{ variant_with_color.id }}"
                                data-color-id="{{ color.id }}"
                                onclick="switchCardVariant(event, {{ p.id }}, {{ variant_with_color.id }}, '{{ color.hex }}', '{{ color.name }}')"
                                title="{{ color.name }}"
                                style="background-color: {{ color.hex }};"
                                aria-label="Select {{ color.name }} variant">
                        </button>
                      {% endif %}
                    {% endfor %}
                  </div>
                {% endif %}
              </div>
              {% endif %}
            </div>

            <div class="product-buttons">
  {# Check variant-level availability if default variant exists, otherwise check product-level #}
  {% set default_variant_available = p.default_variant.is_available if p.default_variant else p.is_available %}

  <button class="btn-add-cart {{ 'in-stock' if default_variant_available else 'out-of-stock' }}"
          type="button"
          data-product-id="{{ p.id }}"
          data-variant-id="{{ p.default_variant.id if p.default_variant else '' }}"
          data-product-name="{{ p.name|e }}"
          data-product-base-name="{{ p.name|e }}"
          data-product-price="{{ p.price }}"
          data-quantity-on-hand="{{ p.quantity_on_hand or 0 }}"
          data-is-available="{{ default_variant_available|lower }}"
          {% if not default_variant_available %}disabled{% endif %}>
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
      <circle cx="9" cy="21" r="1"></circle>
      <circle cx="20" cy="21" r="1"></circle>
      <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6"></path>
    </svg>
    <span class="btn-text">
      {% if default_variant_available %}
        Add&nbsp;to&nbsp;Cart
      {% else %}
        Out&nbsp;of&nbsp;Stock
      {% endif %}
    </span>
  </button>

  <button class="btn-wishlist"
          type="button"
          data-product-id="{{ p.id }}"
          data-product-name="{{ p.name|e }}"
          data-variant-id="{{ p.default_variant.id if p.default_variant else '' }}"
          aria-label="Add {{ p.name|e }} to wishlist">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none"
         stroke="currentColor" stroke-width="2"
         stroke-linecap="round" stroke-linejoin="round">
      <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
    </svg>
  </button>
</div>

          </div>
        </div>
        {% endfor %}

        {% if products.total == 0 %}
          <p style="grid-column:1/-1;text-align:center;padding:3rem 0">No products found.</p>
        {% endif %}
      </div>

      {# â”€â”€ Pagination â”€â”€ #}
      {% if products.pages > 1 %}
      <div class="fb2-pagination">
        {% if products.has_prev %}
          <a href="{{ url_for('main.products', page=products.prev_num, **request.args.to_dict()|reject_keys(['page'])) }}" class="fb2-page-btn">
            <i class="fas fa-chevron-left"></i> Prev
          </a>
        {% endif %}

        <div class="fb2-page-numbers">
          {% for page_num in products.iter_pages(left_edge=1, left_current=2, right_current=2, right_edge=1) %}
            {% if page_num %}
              {% if page_num == products.page %}
                <span class="fb2-page-btn active">{{ page_num }}</span>
              {% else %}
                <a href="{{ url_for('main.products', page=page_num, **request.args.to_dict()|reject_keys(['page'])) }}" class="fb2-page-btn">{{ page_num }}</a>
              {% endif %}
            {% else %}
              <span class="fb2-page-dots">...</span>
            {% endif %}
          {% endfor %}
        </div>

        {% if products.has_next %}
          <a href="{{ url_for('main.products', page=products.next_num, **request.args.to_dict()|reject_keys(['page'])) }}" class="fb2-page-btn">
            Next <i class="fas fa-chevron-right"></i>
          </a>
        {% endif %}
      </div>
      {% endif %}
    </div>
  </section>

  {# â–‘â–‘â–‘ MODALS & FOOTER â–‘â–‘â–‘ #}
  {% include "wishlist_modal.html" %}
  {% include "cart_modal.html" %}
  {% include "login_register_modal.html" %}
  {% include "logged_in_modal.html" %}
  {% include "footer.html" %}

  <!-- Optional server-rendered stack (empty is fine) -->
  <div id="flashStack" class="toast-stack" aria-live="polite" aria-atomic="true"></div>

  <!-- NEW: Category / Subcategory bottom sheet -->
  <div id="categorySheet" class="filter-sheet" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="sheet-backdrop" data-close-sheet></div>
    <div class="sheet-panel" role="document" tabindex="-1">
      <div class="sheet-grabber" aria-hidden="true"></div>

      <header class="sheet-header">
        <h3 class="sheet-title">Choose Category</h3>
        <button class="sheet-close" type="button" aria-label="Close">Ã—</button>
      </header>

      <div class="sheet-content">
        <!-- Sort Options (New for mobile parity) -->
        <h4 class="section-label">Sort By</h4>
        <ul class="category-list">
          <li>
            <button type="button" class="row mobile-sort-item" data-sort="bestseller">
              <span class="label"><i class="fas fa-crown" style="margin-right:8px;color:#ffd700;"></i> Best Sellers</span>
              <span class="check" aria-hidden="true"></span>
            </button>
          </li>
          <li>
            <button type="button" class="row mobile-sort-item" data-sort="newest">
              <span class="label"><i class="fas fa-clock" style="margin-right:8px;"></i> Newest</span>
              <span class="check" aria-hidden="true"></span>
            </button>
          </li>
          <li>
            <button type="button" class="row mobile-sort-item" data-sort="low-high">
              <span class="label"><i class="fas fa-arrow-down-short-wide" style="margin-right:8px;"></i> Price Low â†’ High</span>
              <span class="check" aria-hidden="true"></span>
            </button>
          </li>
          <li>
            <button type="button" class="row mobile-sort-item" data-sort="high-low">
              <span class="label"><i class="fas fa-arrow-up-wide-short" style="margin-right:8px;"></i> Price High â†’ Low</span>
              <span class="check" aria-hidden="true"></span>
            </button>
          </li>
        </ul>

        <div class="section-divider"></div>

        <!-- Gender Section -->
        <h4 class="section-label">Gender</h4>
        <ul class="category-list">
          <li>
            <button type="button" class="row" data-category="men" data-category-name="Men">
              <span class="label">Men</span><span class="check" aria-hidden="true"></span>
            </button>
          </li>
          <li>
            <button type="button" class="row" data-category="women" data-category-name="Women">
              <span class="label">Women</span><span class="check" aria-hidden="true"></span>
            </button>
          </li>
        </ul>

        <div class="section-divider"></div>

        <!-- Main Categories -->
        <h4 class="section-label" id="mainHeader">Main Categories</h4>
        <ul class="category-list level-1" id="catLevel1">
          {% for category in categories %}
            <li>
              <button
                type="button"
                class="row"
                data-category="{{ category.slug }}"
                data-category-name="{{ category.name|e }}">
                <span class="label">{{ category.name }}</span><span class="check" aria-hidden="true"></span>
              </button>
            </li>
          {% endfor %}
        </ul>

        <div class="section-divider"></div>

        <!-- Subcategories (Flat list below) -->
        <h4 class="section-label">Subcategories</h4>
        <ul class="category-list level-sub">
          {% for category in categories if category.children %}
            {% for sub in category.children %}
              <li>
                <button
                  type="button"
                  class="row"
                  data-category="{{ sub.slug }}"
                  data-category-name="{{ sub.name|e }}">
                  <span class="label">{{ sub.name }}</span><span class="check" aria-hidden="true"></span>
                </button>
              </li>
            {% endfor %}
          {% endfor %}
        </ul>
      </div>

      <footer class="sheet-footer">
        <button class="btn-apply" type="button" id="applyCategory">Close</button>
      </footer>
    </div>
  </div>

  <!-- JS (order matters) -->
  <script src="{{ url_for('static', filename='js/csrf-handler.js') }}?v=20250116-3" defer></script>
  <script src="{{ url_for('static', filename='js/toast.js') }}?v=20250116-3" defer></script>
  <script src="{{ url_for('static', filename='js/mobile-menu.js') }}?v=20250116-3" defer></script>
  <script src="{{ url_for('static', filename='js/index.js') }}?v=20250116-3" defer></script>
  <!-- products pageâ€“only helpers -->
  <script src="{{ url_for('static', filename='js/products.js') }}?v=20250116-3" defer></script>

  <!-- Expose a SAFE, minimal filter state for the sheet -->
  <script>
    window.current_filters = {
      category: {{ (current_filters.category|tojson) if current_filters and current_filters.category else 'null' }},
      category_name: {{ (current_filters.category_name|tojson) if current_filters and current_filters.category_name else 'null' }}
    };
  </script>

  <!-- Category sheet controller (loads after products.js so it can call filterProducts) -->
  <script src="{{ url_for('static', filename='js/filters.js') }}?v=20251004-5" defer></script>
  <script src="{{ url_for('static', filename='js/filter-bar-v2.js') }}?v=20260218" defer></script>

  <!-- Product Card Color Variant Switching -->
  <script>
  window.switchCardVariant = function(e, productId, variantId, colorHex, colorName) {
    e.preventDefault();
    e.stopPropagation();

    const card = document.querySelector(`[data-product-id="${productId}"].product-card`);
    if (!card) return;

    // Update active state for color buttons
    card.querySelectorAll('.card-color-option').forEach(btn => {
      btn.classList.remove('active');
    });
    e.currentTarget.classList.add('active');

    // Update the "Add to Cart" button with new variant ID
    const cartBtn = card.querySelector('.btn-add-cart');
    if (cartBtn) {
      cartBtn.dataset.variantId = variantId;
    }



    // Fetch and update images for the selected variant
    fetch(`/api/variant/${variantId}/images`)
      .then(r => r.json())
      .then(data => {
        if (!(data.success && data.images && data.images.length)) return;

        const srcs = data.images.map(img => 
          (img.startsWith('http') || img.startsWith('/static/')) 
            ? img 
            : `/static/${img.replace(/^\/+/, '')}`
        );

        if (!srcs.length) return;

        // Update the main slideshow image
        const slideshow = card.querySelector('.product-card-slideshow');
        if (slideshow) {
          const mainImg = slideshow.querySelector('.product-slide.active');
          if (mainImg && srcs[0]) {
            mainImg.src = srcs[0] + '?v=' + Date.now();
          }
        }

        // Update image counter if needed
        const counter = card.querySelector('.product-card-image-counter');
        if (counter) {
          const totalSpan = counter.querySelector('.total-images');
          if (totalSpan) totalSpan.textContent = srcs.length;
          const currentSpan = counter.querySelector('.current-image');
          if (currentSpan) currentSpan.textContent = '1';
        }
      })
      .catch(err => console.warn('Failed to load variant images:', err));
  };
  </script>
</body>
</html>
