<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <meta name="description" content="Browse our complete collection of premium adult products ‚Äì LoveMeNow">
    <title>Products ¬∑ LoveMeNow</title>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <!-- Site CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='CSS/styles.css') }}?v=20250116-3">
    
    <!-- Mobile Optimizations CSS -->
    <link rel="preload" href="{{ url_for('static', filename='CSS/mobile-optimizations.css') }}?v=20250116-3" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="{{ url_for('static', filename='CSS/mobile-optimizations.css') }}?v=20250116-3"></noscript>
    
    <!-- CSRF Protection -->
    {% include 'csrf_meta.html' %}
    
    <!-- Google AdWords Tracking -->
    {% include 'google_tag.html' %}
</head>
<body>

{# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
   GLOBAL MACROS
   ----------------------------------------------------------------- #}
    {% macro render_colour_dots(product) -%}
        {% set n = product.colors|length %}
        {# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ 0 colours ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ #}
        {% if n == 0 %}
            <span class="colour-unavailable">Colour N/A</span>

        {# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ exactly 2 colours ‚Üí diagonal split ‚îÄ‚îÄ‚îÄ‚îÄ #}
        {% elif n == 2 %}
            <span class="color-dot diagonal-split"
                  style="background:linear-gradient(135deg,
                         {{ product.colors[0].hex }} 0% 50%,
                         {{ product.colors[1].hex }} 50% 100%);"
                  title="{{ product.colors[0].name }} / {{ product.colors[1].name }}"></span>

        {# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ 3-plus colours ‚Üí one striped gradient ‚îÄ #}
        {% else %}
            {# build ‚Äúhex stop%, nextStop%‚Äù segments #}
            {% set step = 100 // n %}
            {% set stops = [] %}
            {% for c in product.colors %}
                {% set start = loop.index0 * step %}
                {% set end   = loop.index * step %}
                {% set _ = stops.append(c.hex ~ ' ' ~ start ~ '% ' ~ end ~ '%') %}
            {% endfor %}
            <span class="color-dot"
                  style="background:linear-gradient(135deg, {{ stops|join(', ') }});"
                  title="{{ product.colors|map(attribute='name')|join(' / ') }}"></span>
        {% endif %}
    {%- endmacro %}


{# ‚ñë‚ñë‚ñë NAVBAR ‚ñë‚ñë‚ñë #}
{% include "navbar.html" %}

{# ‚ñë‚ñë‚ñë FILTER NAVBAR ‚ñë‚ñë‚ñë #}
<section class="professional-filter-navbar">
    <div class="container">
        <div class="filter-navbar-content">
            <!-- Top Row: Search Only -->
            <div class="filter-top-row">
                <div class="search-section">
                    <div class="search-wrapper">
                        <i class="fas fa-search search-icon"></i>
                        <input type="text"
                               id="productSearch"
                               class="clean-search-input"
                               placeholder="Search products..."
                               value="{{ current_filters.search or '' }}"
                               onkeyup="handleSearch()">
                        <button class="clear-search-btn" onclick="clearSearch()" style="display:none;">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Bottom Row: Category Navigation First -->
            <div class="filter-bottom-row">
                <!-- Secondary Filters Dropdown -->
                <div class="nav-dropdown">
                    <a href="#" class="dropdown-toggle">
                        <span>More Filters</span>
                        <i class="fas fa-chevron-down"></i>
                    </a>
                    <div class="dropdown-menu" style="min-width: 300px;">
                        <div class="dropdown-section">
                            <h4>Filter Options</h4>

                            <!-- In-Stock Toggle -->
                            <div style="padding: 0.5rem 0; border-bottom: 1px solid rgba(255,255,255,0.1);">
                                <div class="filter-section-with-clear">
                                    <label class="toggle-filter" style="display: flex; align-items: center; gap: 0.5rem;">
                                        <input type="checkbox" id="inStockFilter" onchange="handleInStockFilter()" {{ 'checked' if current_filters.in_stock else '' }}>
                                        <span class="toggle-slider-filter"></span>
                                        <span class="toggle-text">In Stock Only</span>
                                    </label>
                                    {% if current_filters.in_stock %}
                                    <button class="filter-clear-btn" onclick="clearInStockFilter()" title="Clear in-stock filter">
                                        <i class="fas fa-times"></i>
                                    </button>
                                    {% endif %}
                                </div>
                            </div>

                            <!-- Brand Filter -->
                            <div style="padding: 0.75rem 0; border-bottom: 1px solid rgba(255,255,255,0.1);">
                                <label style="display: block; color: hsl(var(--text-color)); font-size: 0.8rem; margin-bottom: 0.5rem;">Brand:</label>
                                <div class="filter-section-with-clear">
                                    <select id="brandFilter" class="modern-select" onchange="handleBrandFilter()" style="width: 100%;">
                                        <option value="">All Brands</option>
                                        <option value="rianne" {{ 'selected' if current_filters.brand == 'rianne' else '' }}>Rianne S</option>
                                        <option value="fetish fantasy" {{ 'selected' if current_filters.brand == 'fetish fantasy' else '' }}>Fetish Fantasy</option>
                                        <option value="ouch" {{ 'selected' if current_filters.brand == 'ouch' else '' }}>Ouch!</option>
                                        <option value="adam" {{ 'selected' if current_filters.brand == 'adam' else '' }}>Adam & Eve</option>
                                        <option value="pipedream" {{ 'selected' if current_filters.brand == 'pipedream' else '' }}>Pipedream</option>
                                        <option value="fun factory" {{ 'selected' if current_filters.brand == 'fun factory' else '' }}>Fun Factory</option>
                                        <option value="sportsheets" {{ 'selected' if current_filters.brand == 'sportsheets' else '' }}>Sportsheets</option>
                                    </select>
                                    {% if current_filters.brand %}
                                    <button class="filter-clear-btn" onclick="clearBrandFilter()" title="Clear brand filter">
                                        <i class="fas fa-times"></i>
                                    </button>
                                    {% endif %}
                                </div>
                            </div>

                            <!-- Price Sort -->
                            <div style="padding: 0.75rem 0; border-bottom: 1px solid rgba(255,255,255,0.1);">
                                <label style="display: block; color: hsl(var(--text-color)); font-size: 0.8rem; margin-bottom: 0.5rem;">Sort by Price:</label>
                                <div class="filter-section-with-clear">
                                    <select id="priceSort" class="modern-select" onchange="handlePriceSort()" style="width: 100%;">
                                        <option value="">Default</option>
                                        <option value="low-high" {{ 'selected' if current_filters.sort == 'low-high' else '' }}>Price: Low to High</option>
                                        <option value="high-low" {{ 'selected' if current_filters.sort == 'high-low' else '' }}>Price: High to Low</option>
                                    </select>
                                    {% if current_filters.sort %}
                                    <button class="filter-clear-btn" onclick="clearPriceSortFilter()" title="Clear price sort">
                                        <i class="fas fa-times"></i>
                                    </button>
                                    {% endif %}
                                </div>
                            </div>

                            <!-- Color Filter -->
                            <div style="padding: 0.75rem 0;">
                                <div class="filter-section-with-clear">
                                    <label style="display: block; color: hsl(var(--text-color)); font-size: 0.8rem; margin-bottom: 0.5rem;">Colors:</label>
                                    {% if current_filters.color %}
                                    <button class="filter-clear-btn" onclick="clearColorFilter()" title="Clear color filter">
                                        <i class="fas fa-times"></i>
                                    </button>
                                    {% endif %}
                                </div>
                                <div class="color-grid" id="colorGrid" style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 0.5rem;">
                                    <!-- Color dots will be populated by JavaScript -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Show All Products Button -->
                <a href="#" class="dropdown-toggle" onclick="filterProducts('all')" style="background: linear-gradient(135deg, rgba(168, 85, 247, 0.2), rgba(236, 72, 153, 0.2)); border-color: hsl(var(--primary-color));">
                    <span>All Products</span>
                </a>

                <!-- Main Categories Navigation -->
                {% for category in categories %}
                    {% if category.children %}
                        <div class="nav-dropdown">
                            <a href="#" class="dropdown-toggle">
                                <span>{{ category.name }}</span>
                                <i class="fas fa-chevron-down"></i>
                            </a>
                            <div class="dropdown-menu">
                                <div class="dropdown-section">
                                    <h4>{{ category.name }}</h4>
                                    <a href="#" class="dropdown-item" onclick="filterProducts('{{ category.slug }}')">All {{ category.name }}</a>
                                    {% for subcategory in category.children %}
                                        <a href="#" class="dropdown-item" onclick="filterProducts('{{ subcategory.slug }}')">{{ subcategory.name }}</a>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    {% else %}
                        <a href="#" class="dropdown-toggle" onclick="filterProducts('{{ category.slug }}')">
                            <span>{{ category.name }}</span>
                        </a>
                    {% endif %}
                {% endfor %}

                <!-- Active Category Filter Clear Button -->
                {% if current_filters.category %}
                <a href="#" id="clearFilterButton" class="dropdown-toggle active-category-clear" onclick="clearCategoryFilter()" title="Clear category filter">
                    <i class="fas fa-times"></i>
                    <span>Clear All</span>
                </a>
                {% endif %}

                <!-- Clear All Button -->
                <div class="filter-clear-wrapper">
                    <button id="clearAllFilters" class="btn-clear-filters" onclick="clearAllFilters()">
                        <i class="fas fa-times"></i>
                        Clear All
                    </button>
                </div>

                <!-- Results Counter -->
                <div class="results-info">
                    <span id="resultCount">{{ products.total }} product{{ 's' if products.total != 1 else '' }}</span>
                </div>
            </div>
        </div>
    </div>
</section>

{# ‚ñë‚ñë‚ñë PRODUCTS GRID ‚ñë‚ñë‚ñë #}
<section class="products-section">
    <div class="container">
        <div class="product-grid" id="productGrid">
            {% for p in products.items %}
            <div class="product-card fade-in-up"
                 data-category="{{ p.category.slug|default('uncategorised') }}"
                 data-parent-category="{{ p.category.parent.slug if p.category and p.category.parent else (p.category.slug if p.category else 'uncategorised') }}"
                 data-price="{{ p.price }}"
                 data-rating="{{ p.rating|default(0) }}"
                 data-in-stock="{{ p.is_available|lower }}"
                 data-brand="{{ p.name.split()[0]|lower|replace('!', '')|replace('&', 'and') }}"
                 data-colors="{{ p.available_colors|map(attribute='slug')|join(',') }}"
                 data-product-id="{{ p.id }}"
                 data-default-variant-id="{{ p.default_variant.id if p.default_variant else '' }}"
                 data-has-variants="{{ 'true' if p.variants|length > 1 else 'false' }}"
                 data-product-quantity="{{ p.quantity_on_hand or 0 }}">

                {# ‚îÄ‚îÄ IMAGE WITH SLIDESHOW ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ #}
                <div class="product-image product-card-slideshow" data-product-id="{{ p.id }}">
                    {% if p.variants|length > 1 and p.default_variant %}
                        {# Show only default variant images for multi-variant products #}
                        {% set default_variant_images = p.default_variant.images|map(attribute='url')|list %}
                        {% set all_images = default_variant_images %}
                    {% else %}
                        {# Show all images for single-variant products #}
                        {% set all_images = p.all_image_urls %}
                    {% endif %}

                    {% if all_images %}
                        {% for image_url in all_images %}
                        <img class="product-slide {{ 'active' if loop.first else '' }}"
                             src="{{ image_url if image_url.startswith('http') or image_url.startswith('/static/') else url_for('static', filename=image_url.lstrip('/')) }}"
                             alt="{{ p.name|e }}" 
                             loading="{{ 'eager' if loop.first else 'lazy' }}"
                             style="width: 100%; height: 240px; object-fit: contain; background: rgba(255, 255, 255, 0.02);"
                             onerror="handleImageError(this)">
                        {% endfor %}
                        
                        {% if all_images|length > 1 %}
                        <button class="product-card-nav-arrow prev" onclick="navigateProductCardImage({{ p.id }}, -1)" aria-label="Previous image">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <button class="product-card-nav-arrow next" onclick="navigateProductCardImage({{ p.id }}, 1)" aria-label="Next image">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                        
                        <div class="product-card-image-counter">
                            <span class="current-image">1</span> / <span class="total-images">{{ all_images|length }}</span>
                        </div>
                        {% endif %}
                    {% elif p.main_image_url %}
                        <img class="product-slide active" 
                             src="{{ p.main_image_url }}" 
                             alt="{{ p.name|e }}" 
                             loading="lazy"
                             onerror="handleImageError(this)"
                             width="480" 
                             height="480">
                        
                        {% if all_images|length > 1 %}
                        <!-- Navigation Arrows -->
                        <button class="product-card-nav-arrow prev" onclick="navigateProductCardImage({{ p.id }}, -1)" aria-label="Previous image">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <button class="product-card-nav-arrow next" onclick="navigateProductCardImage({{ p.id }}, 1)" aria-label="Next image">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                        
                        <!-- Image Counter -->
                        <div class="product-card-image-counter">
                            <span class="current-index">1</span> / <span class="total-images">{{ all_images|length }}</span>
                        </div>
                        
                        <!-- Store images data for JavaScript -->
                        <script type="application/json" class="product-images-data">
                        [
                            {% for image in all_images %}
                            "{{ image }}"{{ ',' if not loop.last else '' }}
                            {% endfor %}
                        ]
                        </script>
                        {% endif %}
                        
                        <!-- Store variant data for color switching -->
                        {% if p.variants|length > 1 %}
                        <script type="application/json" class="product-variants-data">
                        {
                            "variants": [
                                {% for variant in p.variants %}
                                {
                                    "id": {{ variant.id }},
                                    "color_id": {{ variant.color_id or 'null' }},
                                    "color_name": "{{ variant.color.name if variant.color else 'Default' }}",
                                    "color_hex": "{{ variant.color.hex if variant.color else '#808080' }}",
                                    "is_available": {{ variant.is_available|lower }},
                                    "quantity_on_hand": {{ variant.quantity_on_hand or 0 }},
                                    "images": [
                                        {% for img in variant.images %}
                                        {% if img.url.startswith('http') %}
                                        "{{ img.url }}"
                                        {% elif img.url.startswith('/static/') %}
                                        "{{ img.url }}"
                                        {% elif img.url.startswith('static/') %}
                                        "/{{ img.url }}"
                                        {% else %}
                                        "{{ url_for('static', filename=img.url) }}"
                                        {% endif %}{{ ',' if not loop.last else '' }}
                                        {% endfor %}
                                    ]
                                }{{ ',' if not loop.last else '' }}
                                {% endfor %}
                            ],
                            "default_variant_id": {{ p.default_variant.id if p.default_variant else 'null' }}
                        }
                        </script>
                        {% endif %}
                    {% else %}
                        <div class="placeholder-image">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                <circle cx="9" cy="9" r="2"></circle>
                                <path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"></path>
                            </svg>
                        </div>
                    {% endif %}
                </div>

                {# ‚îÄ‚îÄ INFO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ #}
                <div class="product-info">
                    <div class="product-content">
                        <div class="product-category">{{ p.category.name if p.category else 'Featured' }}</div>
                        <h3 class="product-title">
                            <a href="/product/{{ p.id }}">{{ p.name }}</a>
                        </h3>

                        <div class="product-price">${{ '%.2f'|format(p.price) }}</div>

                    </div>
                    <!--
                    <p class="product-description">
                        {% if p.description %}{{ p.description|truncate(80, True, '...') }}{% else %}Premium quality product for your intimate moments.{% endif %}
                    </p>
                    -->
                    <div class="product-buttons">
                        {# products.html ‚îÄ inside each product‚Äëcard #}
                        <!-- inside each product card -->
<button class="btn-add-cart"
        data-product-id="{{ p.id }}"
        data-variant-id="{{ p.default_variant.id if p.default_variant else '' }}"
        data-product-name="{{ p.name|e }}"
        data-product-price="{{ p.price }}"
        data-quantity-on-hand="{{ p.quantity_on_hand or 0 }}"
        {% if not p.is_available %}disabled{% endif %}>
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
        <circle cx="9" cy="21" r="1"></circle>
        <circle cx="20" cy="21" r="1"></circle>
        <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
    </svg>
    <span class="btn-text">{% if p.is_available %}Add&nbsp;to&nbsp;Cart{% else %}Out&nbsp;of&nbsp;Stock{% endif %}</span>
</button>


                        <button class="btn-wishlist" data-product-id="{{ p.id }}" data-product-name="{{ p.name|e }}">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
            {% endfor %}
            {% if products.total == 0 %}
                <p style="grid-column:1/-1;text-align:center;padding:3rem 0">No products found.</p>
            {% endif %}
        </div>
    </div>
</section>

{# ‚ñë‚ñë‚ñë MODALS & SCRIPTS (unchanged) ‚ñë‚ñë‚ñë #}
<!-- (unchanged content omitted for brevity) -->



{# ‚ñë‚ñë‚ñë WISHLIST MODAL ‚ñë‚ñë‚ñë #}
    {% include "wishlist_modal.html" %}

    {# ‚ñë‚ñë‚ñë CART MODAL ‚ñë‚ñë‚ñë #}
    {% include "cart_modal.html" %}

    {# ‚ñë‚ñë‚ñë AUTH MODALS ‚ñë‚ñë‚ñë #}
    {% include "login_register_modal.html" %}
    {% include "logged_in_modal.html" %}

    {# ‚ñë‚ñë‚ñë FOOTER ‚ñë‚ñë‚ñë #}
    {% include "footer.html" %}

<script defer src="{{ url_for('static', filename='js/index.js') }}?v=20250116-3"></script>

<script>
// Handle image loading errors - fallback from webp to jpeg
function handleImageError(img) {
    const src = img.src;
    
    // If it's a webp image that failed, try to load the jpeg version
    if (src.includes('__alpha.webp')) {
        const jpegSrc = src.replace('__alpha.webp', '.jpg');
        console.log('WebP failed, trying JPEG:', jpegSrc);
        img.src = jpegSrc;
        img.onerror = function() {
            // If JPEG also fails, try without __alpha
            const fallbackSrc = src.replace('_alpha.webp', '.jpg').replace('__alpha.webp', '.jpg');
            console.log('JPEG failed, trying fallback:', fallbackSrc);
            img.src = fallbackSrc;
            img.onerror = function() {
                // Final fallback - show placeholder
                img.style.display = 'none';
                const placeholder = document.createElement('div');
                placeholder.className = 'image-placeholder';
                placeholder.style.cssText = 'width: 100%; height: 240px; background: #f0f0f0; display: flex; align-items: center; justify-content: center; color: #666; font-size: 14px;';
                placeholder.textContent = 'Image not available';
                img.parentNode.insertBefore(placeholder, img);
            };
        };
    } else if (src.includes('.webp')) {
        // Try replacing .webp with .jpg
        const jpegSrc = src.replace('.webp', '.jpg');
        console.log('WebP failed, trying JPEG:', jpegSrc);
        img.src = jpegSrc;
        img.onerror = function() {
            // Final fallback - show placeholder
            img.style.display = 'none';
            const placeholder = document.createElement('div');
            placeholder.className = 'image-placeholder';
            placeholder.style.cssText = 'width: 100%; height: 220px; background: #f0f0f0; display: flex; align-items: center; justify-content: center; color: #666; font-size: 14px;';
            placeholder.textContent = 'Image not available';
            img.parentNode.insertBefore(placeholder, img);
        };
    }
}

// Initialize search functionality on page load
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('productSearch');
    const clearButton = document.querySelector('.clear-search-btn');
    
    // Show clear button if there's a search term
    if (searchInput && clearButton) {
        if (searchInput.value.trim()) {
            clearButton.style.display = 'block';
        }
    }
    
    // Initialize product card slideshows
    initializeProductCardSlideshows();
});

// Product Card Slideshow Functionality
const productCardImages = {};
const productCardCurrentIndex = {};

function initializeProductCardSlideshows() {
    // Find all product cards with slideshows
    const slideshows = document.querySelectorAll('.product-card-slideshow');
    
    slideshows.forEach(slideshow => {
        const productId = slideshow.getAttribute('data-product-id');
        const imagesScript = slideshow.querySelector('.product-images-data');
        
        if (imagesScript && productId) {
            try {
                // Parse the JSON data
                const images = JSON.parse(imagesScript.textContent);
                
                // Fix HTML entity encoding in URLs
                for (let i = 0; i < images.length; i++) {
                    images[i] = images[i].replace(/&amp;/g, '&');
                }
                
                // Store images and initialize index
                productCardImages[productId] = images;
                productCardCurrentIndex[productId] = 0;
                
                // Set initial image
                const img = slideshow.querySelector('.product-img');
                if (img && images.length > 0) {
                    img.src = images[0];
                }
            } catch (e) {
                console.error('Error parsing product images data:', e);
            }
        }
    });
}

function navigateProductCardImage(productId, direction) {
    const images = productCardImages[productId];
    if (!images || images.length <= 1) return;
    
    // Calculate new index
    let newIndex = productCardCurrentIndex[productId] + direction;
    
    // Handle looping
    if (newIndex >= images.length) {
        newIndex = 0;
    } else if (newIndex < 0) {
        newIndex = images.length - 1;
    }
    
    // Update current index
    productCardCurrentIndex[productId] = newIndex;
    
    // Update image
    const slideshow = document.querySelector(`.product-card-slideshow[data-product-id="${productId}"]`);
    if (slideshow) {
        const img = slideshow.querySelector('.product-img');
        const counter = slideshow.querySelector('.current-index');
        
        if (img && images[newIndex]) {
            img.src = images[newIndex];
        }
        
        if (counter) {
            counter.textContent = newIndex + 1;
        }
    }
}

// Product Variant Switching Functionality
const productVariantsData = {};

// Initialize variant data on page load
document.addEventListener('DOMContentLoaded', function() {
    initializeProductVariants();
});

function initializeProductVariants() {
    // Find all product cards with variants
    const productCards = document.querySelectorAll('.product-card[data-has-variants="true"]');
    
    productCards.forEach(card => {
        const productId = card.getAttribute('data-product-id');
        const variantsScript = card.querySelector('.product-variants-data');
        
        if (variantsScript && productId) {
            try {
                // Parse the JSON data
                const variantData = JSON.parse(variantsScript.textContent);
                productVariantsData[productId] = variantData;
                
                // Set default variant as active and initialize images
                if (variantData.default_variant_id) {
                    const defaultVariant = variantData.variants.find(v => v.id === variantData.default_variant_id);
                    if (defaultVariant && defaultVariant.images && defaultVariant.images.length > 0) {
                        // Update the product card images to show only default variant images
                        productCardImages[productId] = defaultVariant.images;
                        productCardCurrentIndex[productId] = 0;
                        
                        // Update the main image
                        const slideshow = card.querySelector('.product-card-slideshow');
                        const img = slideshow?.querySelector('.product-img');
                        if (img) {
                            img.src = defaultVariant.images[0];
                        }
                        
                        // Update counter
                        const counter = slideshow?.querySelector('.current-index');
                        const totalCounter = slideshow?.querySelector('.total-images');
                        if (counter) counter.textContent = '1';
                        if (totalCounter) totalCounter.textContent = defaultVariant.images.length;
                        
                        console.log(`üéØ PRODUCT CARD INIT: ${productId}`, {
                            defaultVariantId: variantData.default_variant_id,
                            imagesCount: defaultVariant.images.length,
                            colorName: defaultVariant.color_name
                        });
                    }
                    
                    // Set the default color dot as active
                    const colorDots = card.querySelectorAll('.clickable-color-dot');
                    colorDots.forEach(dot => {
                        dot.classList.remove('active');
                        if (parseInt(dot.getAttribute('data-variant-id')) === variantData.default_variant_id) {
                            dot.classList.add('active');
                        }
                    });
                }
            } catch (e) {
                console.error('Error parsing product variants data:', e);
            }
        }
    });
}

function switchProductVariant(productId, variantId) {
    const variantData = productVariantsData[productId];
    if (!variantData) return;
    
    // Find the selected variant
    const selectedVariant = variantData.variants.find(v => v.id === variantId);
    if (!selectedVariant) return;
    
    const productCard = document.querySelector(`.product-card[data-product-id="${productId}"]`);
    if (!productCard) return;
    
    // Update active color dot
    const colorDots = productCard.querySelectorAll('.clickable-color-dot');
    colorDots.forEach(dot => {
        dot.classList.remove('active');
        if (parseInt(dot.getAttribute('data-variant-id')) === variantId) {
            dot.classList.add('active');
        }
    });
    
    // Update product images if variant has images
    if (selectedVariant.images && selectedVariant.images.length > 0) {
        const slideshow = productCard.querySelector('.product-card-slideshow');
        const img = slideshow.querySelector('.product-img');
        
        if (img) {
            // Update main image
            img.src = selectedVariant.images[0];
            
            // Update slideshow data
            productCardImages[productId] = selectedVariant.images;
            productCardCurrentIndex[productId] = 0;
            
            // Update counter
            const counter = slideshow.querySelector('.current-index');
            const totalCounter = slideshow.querySelector('.total-images');
            if (counter) counter.textContent = '1';
            if (totalCounter) totalCounter.textContent = selectedVariant.images.length;
            
            // Show/hide navigation arrows based on image count
            const prevArrow = slideshow.querySelector('.prev');
            const nextArrow = slideshow.querySelector('.next');
            const imageCounter = slideshow.querySelector('.product-card-image-counter');
            
            if (selectedVariant.images.length > 1) {
                if (prevArrow) prevArrow.style.display = 'block';
                if (nextArrow) nextArrow.style.display = 'block';
                if (imageCounter) imageCounter.style.display = 'block';
            } else {
                if (prevArrow) prevArrow.style.display = 'none';
                if (nextArrow) nextArrow.style.display = 'none';
                if (imageCounter) imageCounter.style.display = 'none';
            }
        }
    }
    
    // Update add to cart button
    const addToCartBtn = productCard.querySelector('.btn-add-cart');
    if (addToCartBtn) {
        addToCartBtn.setAttribute('data-variant-id', variantId);
        // Since inventory is at product level, get it from the product data
        const productCard = addToCartBtn.closest('.product-card');
        const productQuantity = productCard ? productCard.dataset.productQuantity : 0;
        addToCartBtn.setAttribute('data-quantity-on-hand', productQuantity);
        
        // Update button state based on availability
        const btnText = addToCartBtn.querySelector('.btn-text');
        if (selectedVariant.is_available) {
            addToCartBtn.disabled = false;
            addToCartBtn.classList.remove('disabled');
            if (btnText) btnText.textContent = 'Add to Cart';
        } else {
            addToCartBtn.disabled = true;
            addToCartBtn.classList.add('disabled');
            if (btnText) btnText.textContent = 'Out of Stock';
        }
    }
    
    // Update product card data attributes
    productCard.setAttribute('data-in-stock', selectedVariant.is_available.toString());
    productCard.setAttribute('data-default-variant-id', variantId);
}
</script>

<!-- Mobile Menu JavaScript -->
<script src="{{ url_for('static', filename='js/mobile-menu.js') }}" defer></script>

</body>
</html>