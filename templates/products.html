<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Google Tag Manager -->
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
  j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
  'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
  })(window,document,'script','dataLayer','GTM-WW7VC75G');</script>
  <!-- End Google Tag Manager -->

  <!-- localStorage Cleanup - Prevent stale data from affecting Lighthouse tests -->
  <script>
    (function() {
      try {
        // Clear stale localStorage data that accumulates over time
        const now = Date.now();
        const maxAge = 7 * 24 * 60 * 60 * 1000; // 7 days
        
        // Get and validate stored timestamp
        const timestamp = localStorage.getItem('lmn_cleanup_ts');
        const lastCleanup = timestamp ? parseInt(timestamp) : 0;
        
        // Only run cleanup every 24 hours to avoid frequent operations
        if (now - lastCleanup > 24 * 60 * 60 * 1000) {
          // Clear promo data if present (can be regenerated)
          localStorage.removeItem('promoModalShown');
          localStorage.removeItem('promoCode');
          
          // Reset cart count if it seems corrupted (e.g., negative values)
          const cartCount = localStorage.getItem('cartCount');
          if (cartCount && (parseInt(cartCount) < 0 || parseInt(cartCount) > 999)) {
            localStorage.removeItem('cartCount');
          }
          
          // Update cleanup timestamp
          localStorage.setItem('lmn_cleanup_ts', now.toString());
        }
      } catch(e) {
        // Silently ignore localStorage errors (e.g., in private/incognito mode)
      }
    })();
  </script>

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <meta name="description" content="Browse our complete collection of premium adult products â€“ LoveMeNow" />
  <title>Products Â· LoveMeNow</title>

  {# --- Preload the first visible product image for faster LCP --- #}
  {% if products.items|length %}
    {% set p0 = products.items[0] %}
    {% if p0.variants|length > 1 and p0.default_variant %}
      {% set imgs = p0.default_variant.images|map(attribute='url')|list %}
      {% if not imgs and p0.image_url %}
        {% set imgs = [p0.image_url] %}
      {% endif %}
    {% else %}
      {% set imgs = p0.all_image_urls %}
      {% if not imgs and p0.image_url %}
        {% set imgs = [p0.image_url] %}
      {% endif %}
    {% endif %}
    {% if imgs and imgs|length %}
      {% set full_url = imgs[0] if imgs[0].startswith('http') or imgs[0].startswith('/static/') else url_for('static', filename=imgs[0].lstrip('/')) %}
      {% set webp_url = full_url.replace('.png', '__alpha.webp').replace('.jpg', '__alpha.webp').replace('.jpeg', '__alpha.webp') if full_url.endswith(('.png', '.jpg', '.jpeg')) else full_url %}
      <link rel="preload" as="image" href="{{ webp_url }}" fetchpriority="high">
    {% endif %}
  {% endif %}

  <!-- Favicon -->
  <link rel="icon" href="{{ url_for('static', filename='IMG/icons/favicon.ico') }}" type="image/x-icon">

  <!-- Fonts / Icons -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preload" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <noscript><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"></noscript>

  <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <noscript><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"></noscript>

  <!-- Critical CSS inline for LCP optimization -->
  <style>
    :root{--primary:278 82% 52%;--accent:291 64% 42%;--text:240 10% 20%;--muted:240 5% 50%;--surface:240 5% 97%;--bg:240 10% 95%;--border:240 5% 90%}
    *{margin:0;padding:0;box-sizing:border-box}
    html{scroll-behavior:smooth;background:hsl(var(--bg))}
    body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;line-height:1.6;color:hsl(var(--text));text-rendering:optimizeLegibility;-webkit-font-smoothing:antialiased}
    .products-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:1.5rem;padding:1.5rem}
    .product-card{background:hsl(var(--surface));border-radius:8px;overflow:hidden;transition:transform .2s}
    .product-card-image{position:relative;width:100%;padding-bottom:100%;background:hsl(var(--bg));overflow:hidden}
    .product-slide{position:absolute;top:0;left:0;width:100%;height:100%;object-fit:contain;opacity:0;transition:opacity .3s;display:none}
    .product-slide.active{opacity:1;display:block}
    picture{display:contents}
    .product-info{padding:1rem}
    .product-title{font-size:.95rem;font-weight:600;line-height:1.2;margin:.5rem 0}
    .product-price{font-size:1.1rem;color:hsl(var(--primary));font-weight:700}
  </style>

  <!-- Non-critical CSS - load async -->
  <link rel="preload" href="{{ url_for('static', filename='CSS/styles.css') }}?v=20250116-4" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <noscript><link rel="stylesheet" href="{{ url_for('static', filename='CSS/styles.css') }}?v=20250116-4"></noscript>

  <link rel="preload" href="{{ url_for('static', filename='CSS/mobile-optimizations.css') }}?v=20250116-3" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <noscript><link rel="stylesheet" href="{{ url_for('static', filename='CSS/mobile-optimizations.css') }}?v=20250116-3"></noscript>

  <!-- Mobile filter sheet styles -->
  <link rel="preload" href="{{ url_for('static', filename='CSS/filters-sheet.css') }}?v=20251004-2" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <noscript><link rel="stylesheet" href="{{ url_for('static', filename='CSS/filters-sheet.css') }}?v=20251004-2"></noscript>

   <link rel="stylesheet" href="{{ url_for('static', filename='CSS/overrides.css') }}?v=20251104-2">


  <!-- CSRF + Tags -->
  {% include 'csrf_meta.html' %}
  {% include 'google_tag.html' %}

  <!-- Toast styles (kept local) -->
  <style>
    .toast-stack{position:fixed;top:16px;right:16px;display:flex;flex-direction:column;gap:10px;z-index:2147483647;pointer-events:none}
    .toast,.flash-message,.notification{pointer-events:auto;display:flex;align-items:flex-start;gap:12px;min-width:260px;max-width:460px;background:#111;color:#fff;border-radius:12px;padding:12px 14px;box-shadow:0 8px 30px rgba(0,0,0,.25);font:500 14px/1.35 Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    .toast.success,.flash-message.success{background:#10b981!important;box-shadow:0 4px 12px rgba(16,185,129,.35)!important}
    .toast.error,.flash-message.error{background:#dc2626}
    .toast.info,.flash-message.info{background:#3b82f6}
    .toast .msg,.flash-message .msg{flex:1 1 auto}
    .toast .close,.flash-message .close,[data-close]{margin-left:auto;border:0;background:transparent;color:inherit;font-size:16px;cursor:pointer;opacity:.85}
    .toast.fade-out,.flash-message.fade-out,.notification.fade-out{opacity:0;transform:translateY(-6px);transition:opacity .25s ease,transform .25s ease}
  </style>
</head>
<body>

  <!-- Google Tag Manager (noscript) -->
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-WW7VC75G" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  <!-- End Google Tag Manager (noscript) -->

  {# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     GLOBAL MACROS
     ----------------------------------------------------------------- #}
  {% macro render_colour_dots(product) -%}
    {% set n = product.colors|length %}
    {% if n == 0 %}
      <span class="colour-unavailable">Colour N/A</span>
    {% elif n == 2 %}
      <span class="color-dot diagonal-split"
            style="background:linear-gradient(135deg,
                   {{ product.colors[0].hex }} 0% 50%,
                   {{ product.colors[1].hex }} 50% 100%);"
            title="{{ product.colors[0].name }} / {{ product.colors[1].name }}"></span>
    {% else %}
      {% set step = 100 // n %}
      {% set stops = [] %}
      {% for c in product.colors %}
        {% set start = loop.index0 * step %}
        {% set end   = loop.index * step %}
        {% set _ = stops.append(c.hex ~ ' ' ~ start ~ '% ' ~ end ~ '%') %}
      {% endfor %}
      <span class="color-dot"
            style="background:linear-gradient(135deg, {{ stops|join(', ') }});"
            title="{{ product.colors|map(attribute='name')|join(' / ') }}"></span>
    {% endif %}
  {%- endmacro %}

  {# â–‘â–‘â–‘ NAVBAR â–‘â–‘â–‘ #}
  {% include "navbar.html" %}

  {# â–‘â–‘â–‘ FILTER NAVBAR â–‘â–‘â–‘ #}
  <section class="professional-filter-navbar">
    <div class="container">
      <div class="filter-navbar-content">
        <!-- Top Row: Search Only -->
        <div class="filter-top-row">
          <div class="search-section">
            <div class="search-wrapper">
              <i class="fas fa-search search-icon"></i>
              <input type="text"
                     id="productSearch"
                     class="clean-search-input"
                     placeholder="Search products..."
                     value="{{ current_filters.search or '' }}"
                     onkeyup="handleSearch()">
              <button class="clear-search-btn" onclick="clearSearch()" style="display:none;">
                <i class="fas fa-times"></i>
              </button>
            </div>
          </div>
        </div>

        <!-- MOBILE: category toolbar (hidden on desktop via CSS) -->
        <div class="mobile-category-toolbar">
          <button id="openCategorySheet" class="btn-category-picker" type="button">
            <span id="mobileCategoryLabel">ðŸ‘† Click to filter/sort</span>
            <i class="fas fa-chevron-down" aria-hidden="true"></i>
          </button>
          <div class="mobile-toolbar-meta">
            <span class="mobile-count" id="mobileResultCount">
              {{ products.total }} product{{ 's' if products.total != 1 else '' }}
            </span>
          </div>
        </div>

        <!-- Bottom Row (desktop / tablet): Category Navigation First -->
        <div class="filter-bottom-row">
          <!-- Gender Filter - Multi-level Dropdown -->
          <div class="nav-dropdown gender-dropdown">
            <a href="#" class="dropdown-toggle">
              <span>Gender</span>
              <i class="fas fa-chevron-down"></i>
            </a>
            <div class="dropdown-menu gender-menu">
              <!-- Men Section -->
              <div class="dropdown-section gender-section">
                <div class="gender-submenu-item">
                  <a href="#" class="gender-submenu-toggle" data-submenu="men-categories">
                    <span>Men</span>
                    <i class="fas fa-chevron-right"></i>
                  </a>
                </div>
                <div id="men-categories" class="gender-submenu" style="display:none;">
                  <a href="#" class="dropdown-item" onclick="filterProducts('men')">All Men</a>
                  <a href="#" class="dropdown-item" onclick="filterProducts('masturbators')">Masturbators</a>
                  <a href="#" class="dropdown-item" onclick="filterProducts('cock-rings')">Cock Rings</a>
                  <a href="#" class="dropdown-item" onclick="filterProducts('cock-pumps')">Cock Pumps</a>
                  <a href="#" class="dropdown-item" onclick="filterProducts('dildos')">Dildos</a>
                  <a href="#" class="dropdown-item" onclick="filterProducts('lubricant')">Lubricants</a>
                  <a href="#" class="dropdown-item" onclick="filterProducts('Water Based Lubricant')">Water Based Lubricant</a>
                  <a href="#" class="dropdown-item" onclick="filterProducts('oil based')">Oil Based Lubricant</a>
                  <a href="#" class="dropdown-item" onclick="filterProducts('Massage Oil')">Massage Oil</a>
                  <a href="#" class="dropdown-item" onclick="filterProducts('butt-plug')">Butt Plugs</a>
                  <a href="#" class="dropdown-item" onclick="filterProducts('penis-extensions')">Penis Extensions</a>
                  <a href="#" class="dropdown-item" onclick="filterProducts('anal-beads')">Anal Beads</a>
                  <a href="#" class="dropdown-item" onclick="filterProducts('douches-and-enemas')">Douches & Enemas</a>
                </div>
              </div>
              
              <!-- Women Section -->
              <div class="dropdown-section gender-section">
                <div class="gender-submenu-item">
                  <a href="#" class="gender-submenu-toggle" data-submenu="women-categories">
                    <span>Women</span>
                    <i class="fas fa-chevron-right"></i>
                  </a>
                </div>
                <div id="women-categories" class="gender-submenu" style="display:none;">
                  <a href="#" class="dropdown-item" onclick="filterProducts('women')">All Women</a>
                  <a href="#" class="dropdown-item" onclick="filterProducts('vibrators')">Vibrators</a>
                  <a href="#" class="dropdown-item" onclick="filterProducts('wands')">Wands</a>
                  <a href="#" class="dropdown-item" onclick="filterProducts('lingerie')">Lingerie</a>
                  <a href="#" class="dropdown-item" onclick="filterProducts('dildos')">Dildos</a>
                  <a href="#" class="dropdown-item" onclick="filterProducts('strap-on-kits')">Strap-ons</a>
                  <a href="#" class="dropdown-item" onclick="filterProducts('bdsm')">BDSM</a>
                  <a href="#" class="dropdown-item" onclick="filterProducts('masks')">Masks</a>
                  <a href="#" class="dropdown-item" onclick="filterProducts('restraints')">Restraints</a>
                  <a href="#" class="dropdown-item" onclick="filterProducts('collars-nipple-clamps')">Collars & Clamps</a>
                  <a href="#" class="dropdown-item" onclick="filterProducts('nipple-clamps')">Nipple Clamps</a>
                  <a href="#" class="dropdown-item" onclick="filterProducts('lubricant')">Lubricants</a>
                  <a href="#" class="dropdown-item" onclick="filterProducts('Water Based Lubricant')">Water Based Lubricant</a>
                  <a href="#" class="dropdown-item" onclick="filterProducts('oil based')">Oil Based Lubricant</a>
                  <a href="#" class="dropdown-item" onclick="filterProducts('Massage Oil')">Massage Oil</a>
                  <a href="#" class="dropdown-item" onclick="filterProducts('anal-toys')">Anal Toys</a>
                  <a href="#" class="dropdown-item" onclick="filterProducts('butt-plug')">Butt Plugs</a>
                  <a href="#" class="dropdown-item" onclick="filterProducts('anal-beads')">Anal Beads</a>
                </div>
              </div>
            </div>
          </div>

          {% for category in categories %}
            {% if category.children %}
              <div class="nav-dropdown">
                <a href="#" class="dropdown-toggle">
                  <span>{{ category.name }}</span>
                  <i class="fas fa-chevron-down"></i>
                </a>
                <div class="dropdown-menu">
                  <div class="dropdown-section">
                    <h4>{{ category.name }}</h4>
                    <a href="#" class="dropdown-item" onclick="filterProducts('{{ category.slug }}')">All {{ category.name }}</a>
                    {% for subcategory in category.children %}
                      <a href="#" class="dropdown-item" onclick="filterProducts('{{ subcategory.slug }}')">{{ subcategory.name }}</a>
                    {% endfor %}
                  </div>
                </div>
              </div>
            {% else %}
              <a href="#" class="dropdown-toggle" onclick="filterProducts('{{ category.slug }}')">
                <span>{{ category.name }}</span>
              </a>
            {% endif %}
          {% endfor %}

          {% if current_filters.category %}
          <a href="#" id="clearFilterButton" class="dropdown-toggle active-category-clear" onclick="clearCategoryFilter()" title="Clear category filter">
            <i class="fas fa-times"></i>
            <span>Clear All</span>
          </a>
          {% endif %}

          <div class="filter-clear-wrapper">
            <button id="clearAllFilters" class="btn-clear-filters" onclick="clearAllFilters()">
              <i class="fas fa-times"></i>
              Clear All
            </button>
          </div>

          <div class="results-info">
            <span id="resultCount">{{ products.total }} product{{ 's' if products.total != 1 else '' }}</span>
          </div>
        </div>
      </div>
    </div>
  </section>

  {# â–‘â–‘â–‘ PRODUCTS GRID â–‘â–‘â–‘ #}
  <section class="products-section">
    <div class="container">
      <div class="product-grid" id="productGrid">
        {% for p in products.items %}
          {% set is_first_card = loop.first %}
        <div class="product-card fade-in-up"
             data-category="{{ p.category.slug|default('uncategorised') }}"
             data-parent-category="{{ p.category.parent.slug if p.category and p.category.parent else (p.category.slug if p.category else 'uncategorised') }}"
             data-price="{{ p.price }}"
             data-rating="{{ p.rating|default(0) }}"
             data-in-stock="{{ p.is_available|lower }}"
             data-brand="{{ p.name.split()[0]|lower|replace('!', '')|replace('&', 'and') }}"
             data-colors="{{ p.available_colors|map(attribute='slug')|join(',') }}"
             data-product-id="{{ p.id }}"
             data-default-variant-id="{{ p.default_variant.id if p.default_variant else '' }}"
             data-has-variants="{{ 'true' if p.variants|length > 1 else 'false' }}"
             data-product-quantity="{{ p.quantity_on_hand or 0 }}">

          <!-- IMAGE WITH SLIDESHOW -->
          <div class="product-image product-card-slideshow" data-product-id="{{ p.id }}">
            {% if p.variants|length > 1 and p.default_variant %}
              {% set default_variant_images = p.default_variant.images|map(attribute='url')|list %}
              {% set all_images = default_variant_images %}
              {% if not all_images and p.image_url %}
                {# Fallback: show product.image_url even when variants exist but have no images yet #}
                {% set all_images = [p.image_url] %}
              {% endif %}
            {% else %}
              {% set all_images = p.all_image_urls %}
              {% if not all_images and p.image_url %}
                {# Fallback: show product.image_url if no variant images yet #}
                {% set all_images = [p.image_url] %}
              {% endif %}
            {% endif %}

            {% if all_images %}
              {% for image_url in all_images %}
                {% set full_url = image_url if image_url.startswith('http') or image_url.startswith('/static/') else url_for('static', filename=image_url.lstrip('/')) %}
                {% set webp_url = full_url.replace('.png', '__alpha.webp').replace('.jpg', '__alpha.webp').replace('.jpeg', '__alpha.webp') if full_url.endswith(('.png', '.jpg', '.jpeg')) else full_url %}
                <picture class="product-slide-picture">
                  <source srcset="{{ webp_url }}" type="image/webp">
                  <img
                    class="product-slide {{ 'active' if loop.first else '' }}"
                    src="{{ full_url }}"
                    alt="{{ p.name|e }}"
                    width="480" height="480"
                    style="width:100%;height:90%; margin-top: 6%;object-fit:contain;aspect-ratio:1;"
                    onerror="handleImageError(this)"
                    decoding="async"
                    loading="{{ 'eager' if is_first_card and loop.first else 'lazy' }}"
                    fetchpriority="{{ 'high' if is_first_card and loop.first else 'auto' }}"
                  >
                </picture>
              {% endfor %}
              {% if all_images|length > 1 %}
                <button class="product-card-nav-arrow prev" onclick="navigateProductCardImage({{ p.id }}, -1)" aria-label="Previous image">
                  <i class="fas fa-chevron-left"></i>
                </button>
                <button class="product-card-nav-arrow next" onclick="navigateProductCardImage({{ p.id }}, 1)" aria-label="Next image">
                  <i class="fas fa-chevron-right"></i>
                </button>
                <div class="product-card-image-counter">
                  <span class="current-image">1</span> / <span class="total-images">{{ all_images|length }}</span>
                </div>
              {% endif %}
            {% elif p.main_image_url %}
              {% set webp_main = p.main_image_url.replace('.png', '__alpha.webp').replace('.jpg', '__alpha.webp').replace('.jpeg', '__alpha.webp') if p.main_image_url.endswith(('.png', '.jpg', '.jpeg')) else p.main_image_url %}
              <picture class="product-slide-picture">
                <source srcset="{{ webp_main }}" type="image/webp">
                <img
                  class="product-slide active"
                  src="{{ p.main_image_url }}"
                  alt="{{ p.name|e }}"
                  width="480" height="480"
                  style="width:100%;height:auto;object-fit:contain;aspect-ratio:1;"
                  onerror="handleImageError(this)"
                  decoding="async"
                  loading="{{ 'eager' if is_first_card else 'lazy' }}"
                  fetchpriority="{{ 'high' if is_first_card else 'auto' }}"
                >
              </picture>
            {% else %}
              <div class="placeholder-image">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                  <circle cx="9" cy="9" r="2"></circle>
                  <path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"></path>
                </svg>
              </div>
            {% endif %}
          </div>

          <!-- Wishlist button positioned at top-right -->
          <button class="product-card-wishlist" data-product-id="{{ p.id }}" data-product-name="{{ p.name|e }}" title="Add to wishlist">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
            </svg>
          </button>

          <!-- INFO -->
          <div class="product-info">
            <div class="product-content">
              <div class="product-category">{{ p.category.name if p.category else 'Featured' }}</div>
              <h3 class="product-title">
                <a href="/product/{{ p.id }}">{{ p.name }}</a>
              </h3>
              <div class="product-price">${{ '%.2f'|format(p.price) }}</div>
              
              <!-- Color Variant Selector for Product Cards (only if has variants) -->
              {% if p.variants|length > 1 and p.available_colors %}
              <div class="card-color-selector">
                {% set has_color_variants = p.variants|selectattr('color_id', 'ne', none)|list|length > 0 %}
                {% if has_color_variants %}
                  <div class="card-colors-label">Colors:</div>
                  <div class="card-color-options">
                    {% for color in p.available_colors %}
                      {% set variant_with_color = p.variants|selectattr('color_id', 'equalto', color.id)|first %}
                      {% if variant_with_color %}
                        <button class="card-color-option {{ 'active' if variant_with_color.id == p.default_variant.id else '' }}"
                                data-product-id="{{ p.id }}"
                                data-variant-id="{{ variant_with_color.id }}"
                                data-color-id="{{ color.id }}"
                                onclick="switchCardVariant(event, {{ p.id }}, {{ variant_with_color.id }}, '{{ color.hex }}', '{{ color.name }}')"
                                title="{{ color.name }}"
                                style="background-color: {{ color.hex }};"
                                aria-label="Select {{ color.name }} variant">
                        </button>
                      {% endif %}
                    {% endfor %}
                  </div>
                {% endif %}
              </div>
              {% endif %}
            </div>

            <div class="product-buttons">
              {# Check variant-level availability if default variant exists, otherwise check product-level #}
              {% set default_variant_available = p.default_variant.is_available if p.default_variant else p.is_available %}
              <button class="btn-add-cart {{ 'in-stock' if default_variant_available else 'out-of-stock' }}"
                      data-product-id="{{ p.id }}"
                      data-variant-id="{{ p.default_variant.id if p.default_variant else '' }}"
                      data-product-name="{{ p.name|e }}"
                      data-product-price="{{ p.price }}"
                      data-quantity-on-hand="{{ p.quantity_on_hand or 0 }}"
                      data-is-available="{{ default_variant_available|lower }}"
                      {% if not default_variant_available %}disabled{% endif %}>
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                  <circle cx="9" cy="21" r="1"></circle>
                  <circle cx="20" cy="21" r="1"></circle>
                  <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6"></path>
                </svg>
                <span class="btn-text">{% if default_variant_available %}Add&nbsp;to&nbsp;Cart{% else %}Out&nbsp;of&nbsp;Stock{% endif %}</span>
              </button>
            </div>
          </div>
        </div>
        {% endfor %}

        {% if products.total == 0 %}
          <p style="grid-column:1/-1;text-align:center;padding:3rem 0">No products found.</p>
        {% endif %}
      </div>
    </div>
  </section>

  {# â–‘â–‘â–‘ MODALS & FOOTER â–‘â–‘â–‘ #}
  {% include "wishlist_modal.html" %}
  {% include "cart_modal.html" %}
  {% include "login_register_modal.html" %}
  {% include "logged_in_modal.html" %}
  {% include "footer.html" %}

  <!-- Optional server-rendered stack (empty is fine) -->
  <div id="flashStack" class="toast-stack" aria-live="polite" aria-atomic="true"></div>

  <!-- NEW: Category / Subcategory bottom sheet -->
  <div id="categorySheet" class="filter-sheet" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="sheet-backdrop" data-close-sheet></div>
    <div class="sheet-panel" role="document" tabindex="-1">
      <div class="sheet-grabber" aria-hidden="true"></div>

      <header class="sheet-header">
        <button class="sheet-back" type="button" hidden aria-label="Back">â€¹ Back</button>
        <h3 class="sheet-title">Choose Category</h3>
        <button class="sheet-close" type="button" aria-label="Close">Ã—</button>
      </header>

      <div class="sheet-content">
        <!-- Header for main list -->
        <h4 class="section-label" id="mainHeader">Main Categories</h4>

        <!-- Level 1: parents -->
        <ul class="category-list level-1" id="catLevel1">
          <li>
            <button type="button" class="row" data-category="gender" data-has-children="true" data-children='[{"slug":"men","name":"Men","children":[{"slug":"masturbators","name":"Masturbators"},{"slug":"cock-rings","name":"Cock Rings"},{"slug":"cock-pumps","name":"Cock Pumps"},{"slug":"dildos","name":"Dildos"},{"slug":"lubricant","name":"Lubricants"},{"slug":"Water Based Lubricant","name":"Water Based Lubricant"},{"slug":"oil based","name":"Oil Based Lubricant"},{"slug":"Massage Oil","name":"Massage Oil"},{"slug":"butt-plug","name":"Butt Plugs"},{"slug":"penis-extensions","name":"Penis Extensions"},{"slug":"anal-beads","name":"Anal Beads"},{"slug":"douches-and-enemas","name":"Douches & Enemas"}]},{"slug":"women","name":"Women","children":[{"slug":"vibrators","name":"Vibrators"},{"slug":"wands","name":"Wands"},{"slug":"lingerie","name":"Lingerie"},{"slug":"dildos","name":"Dildos"},{"slug":"strap-on-kits","name":"Strap-ons"},{"slug":"bdsm","name":"BDSM"},{"slug":"masks","name":"Masks"},{"slug":"restraints","name":"Restraints"},{"slug":"collars-nipple-clamps","name":"Collars & Clamps"},{"slug":"nipple-clamps","name":"Nipple Clamps"}]}]'>
              <span class="label">Gender</span><span class="chevron">â€º</span>
            </button>
          </li>
          {% for category in categories %}
            {% set children_slim = [] %}
            {% for sc in (category.children or []) %}
              {% set _ = children_slim.append({'slug': sc.slug, 'name': sc.name}) %}
            {% endfor %}
            {% set has_children = (children_slim|length) > 0 %}
            <li>
              <button
                type="button"
                class="row"
                data-category="{{ category.slug }}"
                data-has-children="{{ 'true' if has_children else 'false' }}"
                data-children='{{ children_slim|tojson }}'
                data-category-name="{{ category.name|e }}">
                <span class="label">{{ category.name }}</span>
                <span class="chevron">â€º</span>
              </button>
            </li>
          {% endfor %}
        </ul>

        <!-- Divider + Sub header (shown after choosing a parent) -->
        <div class="section-divider" id="sectionDivider" hidden></div>
        <h4 class="section-label" id="subHeader" hidden>
          Subcategories â€” <span id="subHeaderName"></span>
        </h4>

        <!-- Level 2: subcategories (built by JS) -->
        <ul class="category-list level-2" id="catLevel2" hidden></ul>
      </div>

      <footer class="sheet-footer">
        <button class="btn-apply" type="button" id="applyCategory" disabled>Apply</button>
      </footer>
    </div>
  </div>

  <!-- JS (order matters) -->
  <script src="{{ url_for('static', filename='js/csrf-handler.js') }}?v=20250116-3" defer></script>
  <script src="{{ url_for('static', filename='js/toast.js') }}?v=20250116-3" defer></script>
  <script src="{{ url_for('static', filename='js/mobile-menu.js') }}?v=20250116-3" defer></script>
  <script src="{{ url_for('static', filename='js/index.js') }}?v=20250116-3" defer></script>
  <!-- products pageâ€“only helpers -->
  <script src="{{ url_for('static', filename='js/products.js') }}?v=20250116-3" defer></script>

  <!-- Expose a SAFE, minimal filter state for the sheet -->
  <script>
    window.current_filters = {
      category: {{ (current_filters.category|tojson) if current_filters and current_filters.category else 'null' }},
      category_name: {{ (current_filters.category_name|tojson) if current_filters and current_filters.category_name else 'null' }}
    };
  </script>

  <!-- Gender Dropdown Submenu Handler -->
  <!-- Gender menu: desktop/mobile click-to-toggle grids (no auto-open) -->
<script>
document.addEventListener('DOMContentLoaded', function () {
  const toggles = document.querySelectorAll('.gender-submenu-toggle');
  const menus   = document.querySelectorAll('.gender-submenu');

  function isDesktop(){ return window.matchMedia('(min-width:769px)').matches; }

  function closeAll(){
    menus.forEach(m => m.classList.remove('open'));
  }

  // Toggle Men/Women grids on click for BOTH desktop and mobile
  toggles.forEach(t => {
    t.addEventListener('click', function(e){
      e.preventDefault();
      const id = this.getAttribute('data-submenu');
      const menu = document.getElementById(id);
      if(!menu) return;
      const willOpen = !menu.classList.contains('open');
      closeAll();
      if (willOpen) menu.classList.add('open');
    }, { passive:false });
  });

  // Close submenus when a subcategory is picked (mobile & desktop)
  document.querySelectorAll('.gender-submenu .dropdown-item').forEach(item=>{
    item.addEventListener('click', () => closeAll());
  });

  // Click outside the Gender dropdown closes submenus
  document.addEventListener('click', (e) => {
    const wrapper = document.querySelector('.gender-dropdown');
    if (wrapper && !wrapper.contains(e.target)) closeAll();
  });
});
</script>

  <!-- NEW: category sheet controller (loads after products.js so it can call filterProducts) -->
  <script src="{{ url_for('static', filename='js/filters.js') }}?v=20251004-5" defer></script>

  <!-- Product Card Color Variant Switching -->
  <script>
  window.switchCardVariant = function(e, productId, variantId, colorHex, colorName) {
    e.preventDefault();
    e.stopPropagation();

    const card = document.querySelector(`[data-product-id="${productId}"].product-card`);
    if (!card) return;

    // Update active state for color buttons
    card.querySelectorAll('.card-color-option').forEach(btn => {
      btn.classList.remove('active');
    });
    e.currentTarget.classList.add('active');

    // Update the "Add to Cart" button with new variant ID
    const cartBtn = card.querySelector('.btn-add-cart');
    if (cartBtn) {
      cartBtn.dataset.variantId = variantId;
    }

    // Fetch variant details to update button state based on stock
    fetch(`/api/product/${productId}`, { cache: 'no-store' })
      .then(r => r.json())
      .then(data => {
        if (!data.success || !data.variants) return;
        
        const variant = data.variants.find(v => v.id === variantId);
        if (!variant) return;
        
        // Update button disabled state, text, and CSS classes based on variant availability
        if (cartBtn) {
          const isAvailable = variant.is_available;
          cartBtn.dataset.isAvailable = isAvailable ? 'true' : 'false';
          
          // Remove both classes first
          cartBtn.classList.remove('in-stock', 'out-of-stock');
          
          if (isAvailable) {
            cartBtn.disabled = false;
            cartBtn.querySelector('.btn-text').textContent = 'Add to Cart';
            cartBtn.classList.add('in-stock');
          } else {
            cartBtn.disabled = true;
            cartBtn.querySelector('.btn-text').textContent = 'Out of Stock';
            cartBtn.classList.add('out-of-stock');
          }
        }
      })
      .catch(err => console.warn('Failed to load variant details:', err));

    // Fetch and update images for the selected variant
    fetch(`/api/variant/${variantId}/images`)
      .then(r => r.json())
      .then(data => {
        if (!(data.success && data.images && data.images.length)) return;

        const srcs = data.images.map(img => 
          (img.startsWith('http') || img.startsWith('/static/')) 
            ? img 
            : `/static/${img.replace(/^\/+/, '')}`
        );

        if (!srcs.length) return;

        // Update the main slideshow image
        const slideshow = card.querySelector('.product-card-slideshow');
        if (slideshow) {
          const mainImg = slideshow.querySelector('.product-slide.active');
          if (mainImg && srcs[0]) {
            mainImg.src = srcs[0] + '?v=' + Date.now();
          }
        }

        // Update image counter if needed
        const counter = card.querySelector('.product-card-image-counter');
        if (counter) {
          const totalSpan = counter.querySelector('.total-images');
          if (totalSpan) totalSpan.textContent = srcs.length;
          const currentSpan = counter.querySelector('.current-image');
          if (currentSpan) currentSpan.textContent = '1';
        }
      })
      .catch(err => console.warn('Failed to load variant images:', err));
  };
  </script>
</body>
</html>
