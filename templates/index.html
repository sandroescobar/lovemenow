<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="LoveMeNow - Premium quality adult products for your intimate moments" />
  <title>LoveMeNow - Premium Adult Products</title>

  <!-- Optimize preconnects - focus on critical domains -->
  <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
  <link rel="preconnect" href="https://js.stripe.com">
  <link rel="dns-prefetch" href="https://www.googletagmanager.com">
  <link rel="dns-prefetch" href="https://www.google-analytics.com">

  <!-- CSRF Token -->
  {% include 'csrf_meta.html' %}

  <!-- Critical inline CSS for immediate rendering (LCP optimization) -->
  <style>
    :root{--primary-color:278 82% 52%;--accent-color:291 64% 42%;--text-color:240 10% 20%;--muted-color:240 5% 50%;--surface-color:240 5% 97%;--background-color:240 10% 95%;--border-color:240 5% 90%;--glass-bg:rgba(255,255,255,.1);--shadow-sm:0 1px 2px rgba(0,0,0,.05);--shadow-md:0 4px 6px rgba(0,0,0,.1);--shadow-lg:0 20px 25px rgba(0,0,0,.15);--radius-sm:4px;--radius-md:8px;--radius-lg:12px}*{margin:0;padding:0;box-sizing:border-box}html{scroll-behavior:smooth;background:hsl(var(--background-color))}body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial,sans-serif;line-height:1.6;color:hsl(var(--text-color));min-height:100vh;text-rendering:optimizeLegibility;-webkit-font-smoothing:antialiased}img{max-width:100%;height:auto;display:block;background:hsl(var(--surface-color))}picture{display:contents}.navbar{position:sticky;top:0;z-index:1000;background:hsl(var(--surface-color));box-shadow:var(--shadow-sm);border-bottom:1px solid hsl(var(--border-color))}.navbar-container{max-width:1400px;margin:0 auto;padding:1rem;display:flex;justify-content:space-between;align-items:center}.navbar-brand{display:flex;align-items:center;gap:.5rem;text-decoration:none;font-size:1.25rem;font-weight:700;color:hsl(var(--primary-color))}.logo-icon{width:32px;height:32px}.navbar-center{display:flex}.nav-links{list-style:none;display:flex;gap:2rem;margin:0}.nav-link{text-decoration:none;color:hsl(var(--text-color));transition:color .2s;font-weight:500}.nav-link:hover{color:hsl(var(--primary-color))}.navbar-actions{display:flex;gap:1rem;align-items:center}.btn{padding:.75rem 1.5rem;border-radius:var(--radius-md);border:none;cursor:pointer;font-weight:600;transition:all .2s;font-size:1rem}.btn-primary{background:hsl(var(--primary-color));color:#fff}.btn-primary:hover{opacity:.9;transform:translateY(-2px)}.btn-lg{padding:1rem 2rem;font-size:1.125rem}.hero{padding:6rem 2rem;text-align:center;background:linear-gradient(135deg,hsl(var(--primary-color)) 0%,hsl(var(--accent-color)) 100%);color:#fff}.hero-content h1{font-size:3rem;margin-bottom:1rem;line-height:1.2;font-weight:700}.hero-content p{font-size:1.25rem;margin-bottom:2rem;opacity:.95}.product-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:2rem;margin:2rem 0}.product-card{background:hsl(var(--surface-color));border-radius:var(--radius-lg);overflow:hidden;transition:transform .3s,box-shadow .3s;box-shadow:var(--shadow-sm)}.product-card:hover{transform:translateY(-4px);box-shadow:var(--shadow-lg)}.product-image{position:relative;width:100%;height:240px;background:rgba(255,255,255,.02);overflow:hidden}.product-slide{position:absolute;width:100%;height:100%;object-fit:contain;opacity:0;transition:opacity .3s}.product-slide.active{opacity:1}.product-info{padding:1.5rem}.product-title{font-size:1rem;margin:0.5rem 0}.product-price{font-size:1.5rem;color:hsl(var(--primary-color));font-weight:700}.container{max-width:1400px;margin:0 auto;padding:0 1rem}
  </style>

  <!-- Non-critical CSS - load asynchronously -->
  <link rel="stylesheet" href="{{ url_for('static', filename='CSS/styles.css') }}" media="print" onload="this.media='all'">
  <noscript><link rel="stylesheet" href="{{ url_for('static', filename='CSS/styles.css') }}"></noscript>

  <!-- Performance optimizations stylesheet -->
  <link rel="preload" href="{{ url_for('static', filename='CSS/performance.css') }}?v=20250116-2" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <noscript><link rel="stylesheet" href="{{ url_for('static', filename='CSS/performance.css') }}?v=20250116-2"></noscript>

  <!-- Mobile optimizations stylesheet -->
  <link rel="preload" href="{{ url_for('static', filename='CSS/mobile-optimizations.css') }}?v=20250116-2" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <noscript><link rel="stylesheet" href="{{ url_for('static', filename='CSS/mobile-optimizations.css') }}?v=20250116-2"></noscript>

  <!-- Icons / Favicon -->
  <link rel="icon" href="{{ url_for('static', filename='IMG/icons/favicon.ico') }}" type="image/x-icon">
  <link rel="apple-touch-icon" href="{{ url_for('static', filename='IMG/icons/apple-touch-icon.png') }}">

  <!-- Font Awesome (async loaded) -->
  <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <noscript><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"></noscript>

  <!-- Mapbox CSS (deferred) -->
  <link rel="preload" href="https://api.mapbox.com/mapbox-gl-js/v3.12.0/mapbox-gl.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <noscript><link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/v3.12.0/mapbox-gl.css"></noscript>

  <!-- Google Analytics & GTM (async, non-blocking) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=GTM-WW7VC75G"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'GTM-WW7VC75G');
  </script>

  <!-- Age verification check (non-blocking, moved to body end) -->
  <script type="module">
    // Deferred age verification to avoid blocking render
    window.ageVerificationReady = new Promise(resolve => {
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', resolve);
      } else {
        resolve();
      }
    });
  </script>

  <!-- Toast styles (kept inline for immediate availability) -->
  <style>
    .toast-stack{position:fixed;top:2rem;right:2rem;z-index:99999;display:flex;flex-direction:column;gap:.5rem}
    .toast{color:#fff;border:none;border-radius:8px;padding:1rem 1.5rem;min-width:300px;position:relative;font-size:1rem;font-weight:600;will-change:transform,opacity;animation:toastSlideInRight .3s ease both;box-shadow:0 4px 12px rgba(0,0,0,.25);transform:translateZ(0);backface-visibility:hidden}
    .toast-success,.toast.success{background:#10b981!important;box-shadow:0 4px 12px rgba(16,185,129,.35)!important}
    .toast-error,.toast-danger,.toast.error,.toast.danger{background:#ef4444!important;box-shadow:0 4px 12px rgba(239,68,68,.35)!important}
    .toast-warning,.toast.warning{background:#f59e0b!important;box-shadow:0 4px 12px rgba(245,158,11,.35)!important}
    .toast-info,.toast.message,.toast.info{background:#3b82f6!important;box-shadow:0 4px 12px rgba(59,130,246,.35)!important}
    .flash_message_close{position:absolute;top:.5rem;right:.5rem;background:none;border:none;color:rgba(255,255,255,.85);cursor:pointer;padding:.25rem;border-radius:4px;transition:opacity .2s;font-size:1rem}
    .flash_message_close:hover{opacity:1}
    @keyframes toastSlideInRight{from{transform:translateX(110%);opacity:0}to{transform:translateX(0);opacity:1}}
    @keyframes toastSlideOutRight{from{transform:translateX(0);opacity:1}to{transform:translateX(110%);opacity:0}}
    @media (max-width:768px){.toast-stack{right:1rem;left:1rem;top:1rem}.toast{min-width:auto}}
  </style>
</head>
<body>

  <!-- Google Tag Manager (noscript) -->
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-WW7VC75G"
  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>

  <!-- NAV -->
  {% include "navbar.html" %}

  <!-- Hero Section (LCP Element - optimized for quick rendering) -->
  <section class="hero">
    <div class="hero-content fade-in-up">
      <h1>Elevate Your Intimate Moments</h1>
      <p class="lead">Discover premium quality products designed to enhance your personal experiences with discreet service and fast delivery.</p>
      <a href="/products" class="btn btn-primary btn-lg">Explore Now</a>
    </div>
  </section>

  <!-- Miami Delivery & Pickup -->
  <section class="miami-service-section">
    <div class="container">
      <div class="miami-content">
        <div class="miami-info">
          <div class="service-badge"><i class="fas fa-map-marker-alt"></i><span>Miami Exclusive</span></div>
          <h2>Premium Service Across the Magic City</h2>
          <p class="miami-description">Experience unparalleled convenience with our discreet delivery and pickup services covering all of Miami-Dade County.</p>

          <div class="service-features">
            <div class="service-feature"><div class="feature-icon"><i class="fas fa-truck"></i></div><div class="feature-content"><h3>Same-Day Delivery</h3><p>Order before 2 PM for same-day delivery across Miami</p></div></div>
            <div class="service-feature"><div class="feature-icon"><i class="fas fa-store"></i></div><div class="feature-content"><h3>Discreet Pickup Points</h3><p>Brickell, Wynwood & Coral Gables</p></div></div>
            <div class="service-feature"><div class="feature-icon"><i class="fas fa-clock"></i></div><div class="feature-content"><h3>24/7 Service</h3><p>Round-the-clock availability</p></div></div>
          </div>

          <div class="miami-cta">
            <a href="/products" class="btn btn-primary btn-lg"><i class="fas fa-shopping-bag"></i> Shop Miami Collection</a>
            <a href="#coverage-map" class="btn-coverage-link"><i class="fas fa-map"></i> View Coverage Areas</a>
          </div>
        </div>

        <div class="miami-visual">
          <div class="miami-map-container" id="map-container">
            <iframe src="/miami-map" class="folium-map" frameborder="0" title="Miami Coverage Map" loading="lazy"
                    onload="document.getElementById('map-fallback').style.display='none';"
                    onerror="showMapFallback();"></iframe>
            <div id="map-fallback" style="display:none;width:100%;height:100%;background:var(--glass-bg);border-radius:1rem;align-items:center;justify-content:center;text-align:center;padding:2rem;">
              <div>
                <h3 style="color:hsl(var(--primary-color));margin-bottom:1rem;">Miami Coverage Map</h3>
                <p style="margin-bottom:1rem;">We deliver throughout Miami-Dade and Broward counties!</p>
                <div style="background:hsl(var(--primary-color));color:#fff;padding:1rem;border-radius:8px;margin-top:1rem;">
                  <h4>🏬 Pickup Location</h4>
                  <p><strong>Miami Vape Smoke Shop</strong></p>
                  <p>351 NE 79th St<br>Miami, FL 33138</p>
                </div>
              </div>
            </div>

            <div class="coverage-stats">
              <div class="stat-item"><div class="stat-number">100+</div><div class="stat-label">Areas Covered</div></div>
              <div class="stat-item"><div class="stat-number">1 Hour</div><div class="stat-label">Avg Delivery</div></div>
              <div class="stat-item"><div class="stat-number">10AM-10PM</div><div class="stat-label">Mon-Sun</div></div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </section>

  <!-- Featured Products -->
  <section class="container" style="padding:4rem 1rem;">
    <div class="text-center mb-4">
      <h2 style="font-size:2.5rem;margin-bottom:1rem;background:linear-gradient(135deg,hsl(var(--primary-color)),hsl(var(--accent-color)));-webkit-background-clip:text;-webkit-text-fill-color:transparent;">Featured Products</h2>
      <p style="font-size:1.125rem;opacity:.8;max-width:600px;margin:0 auto;">Carefully curated selection of our most popular intimate products</p>
    </div>

    <div class="product-grid">
      {% for product in featured_products %}
      <div class="product-card fade-in-up" data-product-id="{{ product.id }}" data-in-stock="{{ product.in_stock|lower }}" data-product-quantity="{{ product.quantity_on_hand or 0 }}">
        <div class="product-image product-card-slideshow" data-product-id="{{ product.id }}">
          {% set all_images = product.all_image_urls %}
          {% if product.image_url and product.image_url not in all_images %}{% set _ = all_images.append(product.image_url) %}{% endif %}
          {% if all_images %}
            {% for image_url in all_images %}
            {% set full_url = image_url if image_url.startswith('http') or image_url.startswith('/static/') else url_for('static', filename=image_url.lstrip('/')) %}
            {% set webp_url = full_url.replace('.png', '__alpha.webp').replace('.jpg', '__alpha.webp').replace('.jpeg', '__alpha.webp') if full_url.endswith(('.png', '.jpg', '.jpeg')) else full_url %}
            <picture>
              {% if full_url.endswith(('.png', '.jpg', '.jpeg')) %}
              <source srcset="{{ webp_url }}" type="image/webp">
              {% endif %}
              <img class="product-slide {{ 'active' if loop.first else '' }}"
                   src="{{ full_url }}"
                   alt="{{ product.name|e }}" loading="{{ 'eager' if loop.first else 'lazy' }}"
                   style="width:100%;height:240px;object-fit:contain;background:rgba(255,255,255,0.02);" onerror="handleImageError(this)">
            </picture>
            {% endfor %}
            {% if all_images|length > 1 %}
              <button class="product-card-nav-arrow prev" onclick="navigateProductCardImage({{ product.id }},-1)" aria-label="Previous image"><i class="fas fa-chevron-left"></i></button>
              <button class="product-card-nav-arrow next" onclick="navigateProductCardImage({{ product.id }}, 1)" aria-label="Next image"><i class="fas fa-chevron-right"></i></button>
              <div class="product-card-image-counter"><span class="current-image">1</span> / <span class="total-images">{{ all_images|length }}</span></div>
            {% endif %}
          {% else %}
            <div class="placeholder-image"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="9" cy="9" r="2"></circle><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"></path></svg></div>
          {% endif %}
          <div class="product-actions"><button class="btn-quick-view" onclick="openQuickView({{ product.id }})"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg></button></div>
        </div>
        <div class="product-info">
          <div class="product-category">{{ product.category.name if product.category else 'Featured' }}</div>
          <h3 class="product-title"><a href="/product/{{ product.id }}">{{ product.clean_name }}</a></h3>
          <div class="product-price">${{ '%.2f'|format(product.price) }}</div>
          <div class="product-buttons">
            <button class="btn-add-cart" data-product-id="{{ product.id }}" data-variant-id="{{ product.default_variant.id if product.default_variant else '' }}" data-product-name="{{ product.name|e }}" data-product-price="{{ product.price }}" data-quantity-on-hand="{{ product.quantity_on_hand or 0 }}" {% if not product.is_available %}disabled{% endif %}>
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="9" cy="21" r="1"></circle><circle cx="20" cy="21" r="1"></circle><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path></svg>
              {{ 'Add to Cart' if product.is_available else 'Out of Stock' }}
            </button>
            <button class="btn-wishlist" data-product-id="{{ product.id }}" data-product-name="{{ product.name|e }}">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>
            </button>
          </div>
        </div>
      </div>
      {% endfor %}

      {% if not featured_products %}
      <div style="grid-column:1/-1;text-align:center;padding:2rem;"><p style="color:hsl(var(--muted-color));">No products available at the moment.</p></div>
      {% endif %}
    </div>

    <div class="text-center mt-4"><a href="/products" class="btn btn-primary btn-lg">View All Products</a></div>
  </section>

  <!-- Wishlist / Cart / Auth Modals -->
  {% include "wishlist_modal.html" %}
  {% include "cart_modal.html" %}
  {% include "login_register_modal.html" %}
  {% include "logged_in_modal.html" %}

  <!-- FOOTER -->
  {% include "footer.html" %}

  <!-- Flash Messages -->
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="toast-stack" id="flashStack" role="status" aria-live="polite">
        {% for category, msg in messages %}
          <div class="toast toast-{{ category }}">
            <button class="flash_message_close" aria-label="Close notification" onclick="this.parentElement.remove()">
              <i class="fas fa-times" aria-hidden="true"></i>
            </button>
            {{ msg }}
          </div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  {% if age_verified %}
  {% include "promo_modal.html" %}
  <script src="{{ url_for('static', filename='js/promo_modal.js') }}?v=20251002-5" defer></script>
  {% endif %}

  <!-- Age verification (deferred to avoid blocking) -->
  {% if not request.args.get('ad_preview') %}
  <script defer>
    (function () {
      var p = location.pathname;
      if (p.startsWith('/auth/age-verification') || p.startsWith('/auth/verify-age')) return;
      if (document.cookie.split(';').some(s => s.trim() === 'age_verified=1')) return;
      var next = encodeURIComponent(location.href);
      location.replace('/auth/age-verification?next=' + next);
    })();
  </script>
  {% endif %}

  <!-- Mapbox JS (async) -->
  <script async src="https://api.mapbox.com/mapbox-gl-js/v3.12.0/mapbox-gl.js"></script>

  <!-- JS (order matters - all deferred for performance) -->
  <script src="{{ url_for('static', filename='js/csrf-handler.js') }}?v=20250116-2" defer></script>
  <script src="{{ url_for('static', filename='js/toast.js') }}?v=20250116-2" defer></script>
  <script src="{{ url_for('static', filename='js/mobile-menu.js') }}?v=20250116-2" defer></script>
  <script src="{{ url_for('static', filename='js/index.js') }}?v=20250116-2" defer></script>
  <script src="{{ url_for('static', filename='js/home.js') }}?v=20250116-2" defer></script>
  <script src="{{ url_for('static', filename='js/discount.js') }}?v=20251001-4" defer></script>

</body>
</html>