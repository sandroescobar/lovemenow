<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <meta name="description" content="Browse our complete collection of premium adult products – LoveMeNow">
    <title>Products · LoveMeNow</title>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <!-- Site CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
</head>
<body>

{# ──────────────────────────────────────────────────────────────────
   GLOBAL MACROS
   ----------------------------------------------------------------- #}
    {% macro render_colour_dots(product) -%}
        {% set n = product.colors|length %}
        {# ───── 0 colours ───────────────────────────── #}
        {% if n == 0 %}
            <span class="colour-unavailable">Colour N/A</span>

        {# ───── exactly 2 colours → diagonal split ──── #}
        {% elif n == 2 %}
            <span class="color-dot diagonal-split"
                  style="background:linear-gradient(135deg,
                         {{ product.colors[0].hex }} 0% 50%,
                         {{ product.colors[1].hex }} 50% 100%);"
                  title="{{ product.colors[0].name }} / {{ product.colors[1].name }}"></span>

        {# ───── 3-plus colours → one striped gradient ─ #}
        {% else %}
            {# build “hex stop%, nextStop%” segments #}
            {% set step = 100 // n %}
            {% set stops = [] %}
            {% for c in product.colors %}
                {% set start = loop.index0 * step %}
                {% set end   = loop.index * step %}
                {% set _ = stops.append(c.hex ~ ' ' ~ start ~ '% ' ~ end ~ '%') %}
            {% endfor %}
            <span class="color-dot"
                  style="background:linear-gradient(135deg, {{ stops|join(', ') }});"
                  title="{{ product.colors|map(attribute='name')|join(' / ') }}"></span>
        {% endif %}
    {%- endmacro %}


{# ░░░ NAVBAR (unchanged) ░░░ #}
<nav class="navbar">
    <div class="container d-flex justify-content-between align-items-center" style="padding: 1rem;">
        <a class="navbar-brand" href="{{ url_for('index') }}">
            <svg class="logo-icon" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
            </svg>
            LoveMeNow
        </a>

        <div class="navbar-center">
            <ul class="nav-links">
                <li><a class="nav-link" href="{{url_for('index')}}">Home</a></li>
                <li><a class="nav-link active" href="{{url_for('products')}}">Shop</a></li>
                <li><a class="nav-link" href="{{url_for('about')}}">About</a></li>
                <li><a class="nav-link" href="{{url_for('support')}}">Support</a></li>
            </ul>
        </div>

        <div class="navbar-actions">
            <div class="nav-buttons">
                <button type="button" onclick="openWishlistModal()" class="nav-icon-btn" title="Wishlist">
                    <i class="fas fa-heart"></i>
                    <span class="icon-badge" id="wishlistCount" style="display: inline-block;">0</span>
                </button>
                <a href="{{ url_for('cart_page') }}" class="nav-icon-btn" title="Cart">
                    <i class="fas fa-shopping-bag"></i>
                    <span class="icon-badge" id="cartCount" style="display: inline-block;">0</span>
                </a>
                {% if current_user.is_authenticated %}
                    <button class="btn btn-primary" id="userMenuButton">Account</button>
                {% else %}
                    <button class="btn btn-primary" id="signInButton">Sign In</button>
                {% endif %}
            </div>
        </div>
    </div>
</nav>

{# ░░░ FILTER NAVBAR ░░░ #}
<section class="professional-filter-navbar">
    <div class="container">
        <div class="filter-navbar-content">
            <!-- Top Row: Search Only -->
            <div class="filter-top-row">
                <div class="search-section">
                    <div class="search-wrapper">
                        <i class="fas fa-search search-icon"></i>
                        <input type="text"
                               id="productSearch"
                               class="clean-search-input"
                               placeholder="Search products..."
                               onkeyup="handleSearch()">
                        <button class="clear-search-btn" onclick="clearSearch()" style="display:none;">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Bottom Row: Category Navigation First -->
            <div class="filter-bottom-row">
                <!-- Secondary Filters Dropdown -->
                <div class="nav-dropdown">
                    <a href="#" class="dropdown-toggle">
                        <span>More Filters</span>
                        <i class="fas fa-chevron-down"></i>
                    </a>
                    <div class="dropdown-menu" style="min-width: 300px;">
                        <div class="dropdown-section">
                            <h4>Filter Options</h4>

                            <!-- In-Stock Toggle -->
                            <div style="padding: 0.5rem 0; border-bottom: 1px solid rgba(255,255,255,0.1);">
                                <label class="toggle-filter" style="display: flex; align-items: center; gap: 0.5rem;">
                                    <input type="checkbox" id="inStockFilter" onchange="handleInStockFilter()">
                                    <span class="toggle-slider-filter"></span>
                                    <span class="toggle-text">In Stock Only</span>
                                </label>
                            </div>

                            <!-- Brand Filter -->
                            <div style="padding: 0.75rem 0; border-bottom: 1px solid rgba(255,255,255,0.1);">
                                <label style="display: block; color: hsl(var(--text-color)); font-size: 0.8rem; margin-bottom: 0.5rem;">Brand:</label>
                                <select id="brandFilter" class="modern-select" onchange="handleBrandFilter()" style="width: 100%;">
                                    <option value="">All Brands</option>
                                    <option value="rianne">Rianne S</option>
                                    <option value="fetish fantasy">Fetish Fantasy</option>
                                    <option value="ouch">Ouch!</option>
                                    <option value="adam">Adam & Eve</option>
                                    <option value="pipedream">Pipedream</option>
                                    <option value="fun factory">Fun Factory</option>
                                    <option value="sportsheets">Sportsheets</option>
                                </select>
                            </div>

                            <!-- Price Sort -->
                            <div style="padding: 0.75rem 0; border-bottom: 1px solid rgba(255,255,255,0.1);">
                                <label style="display: block; color: hsl(var(--text-color)); font-size: 0.8rem; margin-bottom: 0.5rem;">Sort by Price:</label>
                                <select id="priceSort" class="modern-select" onchange="handlePriceSort()" style="width: 100%;">
                                    <option value="">Default</option>
                                    <option value="low-high">Price: Low to High</option>
                                    <option value="high-low">Price: High to Low</option>
                                </select>
                            </div>

                            <!-- Color Filter -->
                            <div style="padding: 0.75rem 0;">
                                <label style="display: block; color: hsl(var(--text-color)); font-size: 0.8rem; margin-bottom: 0.5rem;">Colors:</label>
                                <div class="color-grid" id="colorGrid" style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 0.5rem;">
                                    <!-- Color dots will be populated by JavaScript -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Show All Products Button -->
                <a href="#" class="dropdown-toggle" onclick="filterProducts('all')" style="background: linear-gradient(135deg, rgba(168, 85, 247, 0.2), rgba(236, 72, 153, 0.2)); border-color: hsl(var(--primary-color));">
                    <span>All Products</span>
                </a>

                <!-- Main Categories Navigation -->
                {% for category in categories %}
                    {% if category.children %}
                        <div class="nav-dropdown">
                            <a href="#" class="dropdown-toggle">
                                <span>{{ category.name }}</span>
                                <i class="fas fa-chevron-down"></i>
                            </a>
                            <div class="dropdown-menu">
                                <div class="dropdown-section">
                                    <h4>{{ category.name }}</h4>
                                    <a href="#" class="dropdown-item" onclick="filterProducts('{{ category.slug }}')">All {{ category.name }}</a>
                                    {% for subcategory in category.children %}
                                        <a href="#" class="dropdown-item" onclick="filterProducts('{{ subcategory.slug }}')">{{ subcategory.name }}</a>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    {% else %}
                        <a href="#" class="dropdown-toggle" onclick="filterProducts('{{ category.slug }}')">
                            <span>{{ category.name }}</span>
                        </a>
                    {% endif %}
                {% endfor %}

                <!-- Clear All Button -->
                <div class="filter-clear-wrapper">
                    <button id="clearAllFilters" class="btn-clear-filters" onclick="clearAllFilters()">
                        <i class="fas fa-times"></i>
                        Clear All
                    </button>
                </div>

                <!-- Results Counter -->
                <div class="results-info">
                    <span id="resultCount">{{ products|length }} product{{ 's' if products|length != 1 else '' }}</span>
                </div>
            </div>
        </div>
    </div>
</section>

{# ░░░ PRODUCTS GRID ░░░ #}
<section class="products-section">
    <div class="container">
        <div class="product-grid" id="productGrid">
            {% for p in products %}
            <div class="product-card fade-in-up"
                 data-category="{{ p.category.slug|default('uncategorised') }}"
                 data-parent-category="{{ p.category.parent.slug if p.category and p.category.parent else (p.category.slug if p.category else 'uncategorised') }}"
                 data-price="{{ p.price }}"
                 data-rating="{{ p.rating|default(0) }}"
                 data-in-stock="{{ p.in_stock|lower }}"
                 data-brand="{{ p.name.split()[0]|lower|replace('!', '')|replace('&', 'and') }}"
                 data-colors="{{ p.colors|map(attribute='slug')|join(',') }}"
                 data-product-id="{{ p.id }}">

                {# ── IMAGE ──────────────────────── #}
                <div class="product-image">
                    {% set all_images = [] %}
                    {% if p.image_url %}{% set _ = all_images.append(p.image_url) %}{% endif %}
                    {% for img in p.images %}{% if img.url not in all_images %}{% set _ = all_images.append(img.url) %}{% endif %}{% endfor %}

                    {% if all_images %}
                        <img style="width: 100%; height: 250px; object-fit: cover;" src="{{ all_images[0] if all_images[0].startswith('http') else url_for('static', filename=all_images[0].lstrip('/')) }}" alt="{{ p.name|e }}" loading="lazy">
                    {% else %}
                        <div class="placeholder-image">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                <circle cx="9" cy="9" r="2"></circle>
                                <path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"></path>
                            </svg>
                        </div>
                    {% endif %}



                    <div class="product-actions">
                        <button class="btn-quick-view" onclick="openQuickView({{ p.id }})">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                <circle cx="12" cy="12" r="3"></circle>
                            </svg>
                        </button>
                    </div>
                </div>

                {# ── INFO ───────────────────────── #}
                <div class="product-info">
                    <div class="product-content">
                        <div class="product-category">{{ p.category.name if p.category else 'Featured' }}</div>
                        <h3 class="product-title"><a href="/product/{{ p.id }}">{{ p.name }}</a></h3>

                        {% if p.colors %}
                            <div class="product-colors"><strong>Colors:</strong> {{ render_colour_dots(p) }}</div>
                        {% else %}
                            <div class="product-colors colour-unavailable">Colour: (add in store)</div>
                        {% endif %}

                        <div class="product-price">${{ '%.2f'|format(p.price) }}</div>
                    </div>
                    <!--
                    <p class="product-description">
                        {% if p.description %}{{ p.description|truncate(80, True, '...') }}{% else %}Premium quality product for your intimate moments.{% endif %}
                    </p>
                    -->
                    <div class="product-buttons">
                        {# products.html ─ inside each product‑card #}
                        <!-- inside each product card -->
<button class="btn-add-cart"
        onclick="addToCart({{ p.id }}, {{ p.name|tojson }}, {{ p.price }})"
        data-product-id="{{ p.id }}"
        data-product-name="{{ p.name }}"
        data-product-price="{{ p.price }}">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
        <circle cx="9" cy="21" r="1"></circle>
        <circle cx="20" cy="21" r="1"></circle>
        <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
    </svg>
    {% if p.in_stock %}Add&nbsp;to&nbsp;Cart{% else %}Out&nbsp;of&nbsp;Stock{% endif %}
</button>


                        <button class="btn-wishlist" onclick='toggleWishlist({{ p.id }}, {{ p.name|tojson }}, this)' data-product-id="{{ p.id }}">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
            {% endfor %}
            {% if products|length == 0 %}
                <p style="grid-column:1/-1;text-align:center;padding:3rem 0">No products found.</p>
            {% endif %}
        </div>
    </div>
</section>

{# ░░░ MODALS & SCRIPTS (unchanged) ░░░ #}
<!-- (unchanged content omitted for brevity) -->

{% include "quick_view_modal.html" %}

{# ░░░ WISHLIST MODAL ░░░ #}
    {% include "wishlist_modal.html" %}

    {# ░░░ AUTH MODALS ░░░ #}
    {% if not current_user.is_authenticated %}
        {% include "login_modal.html" %}
        {% include "register_modal.html" %}
    {% else %}
        {% include "logged_in_modal.html" %}
    {% endif %}

    {# ░░░ FOOTER ░░░ #}
    {% include "footer.html" %}

<script defer src="{{ url_for('static', filename='js/index.js') }}"></script>



</body>
</html>
