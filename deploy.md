# LoveMeNow Render Deployment Guide

## Pre-deployment Checklist ✅

### 1. Code Changes Applied
- ✅ Fixed Stripe client secret URL encoding issue
- ✅ Added CSRF exemption for checkout endpoint
- ✅ Enhanced URL decoding logic (backend & frontend)
- ✅ Production security settings configured
- ✅ All dependencies in requirements.txt

### 2. Required Environment Variables for Render
Set these in your Render dashboard:

```bash
# Database (auto-configured by render.yaml)
DB_URL=postgresql://... (from Render database)

# Security
SECRET_KEY=your-secret-key (auto-generated by Render)

# Stripe (REQUIRED - set manually)
STRIPE_SECRET_KEY=sk_live_... (or sk_test_... for testing)
STRIPE_PUBLISHABLE_KEY=pk_live_... (or pk_test_... for testing)
STRIPE_WEBHOOK_SECRET=whsec_... (optional)

# Email (optional)
SENDLAYER_API_KEY=your-sendlayer-key

# Environment
FLASK_ENV=production
```

### 3. Deployment Steps

#### Step 1: Push to Git Repository
```bash
# Add all changes
git add .

# Commit with descriptive message
git commit -m "Fix Stripe checkout URL encoding issue and prepare for production"

# Push to your main branch
git push origin main
```

#### Step 2: Render Dashboard Configuration
1. Go to your Render dashboard
2. Navigate to your LoveMeNow service
3. Set the required environment variables:
   - `STRIPE_SECRET_KEY`
   - `STRIPE_PUBLISHABLE_KEY`
   - `SENDLAYER_API_KEY` (if using email)

#### Step 3: Deploy
- Render will automatically deploy when you push to your connected Git repository
- Monitor the build logs for any issues

### 4. Post-deployment Verification

#### Health Check
Visit: `https://your-app.onrender.com/api/health`
Should return: `{"status": "healthy", "database": "connected"}`

#### Stripe Integration Test
1. Visit your checkout page
2. Check browser console for:
   - ✅ "Client secret looks clean (no URL encoding detected)"
   - ✅ "Client secret format is valid"
   - ✅ Successful Stripe Elements initialization

#### Database Migration (if needed)
If you have new database changes:
```bash
# Connect to your Render service shell and run:
flask db upgrade
```

### 5. Monitoring

#### Logs
- Check Render logs for any errors
- Monitor Stripe dashboard for payment processing

#### Performance
- Monitor response times
- Check database connection health

### 6. Rollback Plan
If issues occur:
1. Revert the Git commit: `git revert HEAD`
2. Push the revert: `git push origin main`
3. Render will auto-deploy the previous version

## Key Files for Deployment

- `render.yaml` - Render service configuration
- `wsgi.py` - Production WSGI entry point
- `requirements.txt` - Python dependencies
- `config.py` - Environment-specific configurations
- `app.py` - Application factory with production settings

## Troubleshooting

### Common Issues:
1. **Environment Variables**: Ensure all required vars are set in Render dashboard
2. **Database Connection**: Check DB_URL format and connection limits
3. **Stripe Keys**: Verify test vs live keys match your environment
4. **HTTPS**: Ensure all URLs use HTTPS in production

### Debug Commands:
```bash
# Check environment variables
echo $FLASK_ENV
echo $DB_URL

# Test database connection
python -c "from app import create_app; app = create_app('production'); print('DB OK')"
```

## Success Indicators ✅

- [ ] Build completes without errors
- [ ] Health check endpoint responds
- [ ] Database connection established
- [ ] Stripe checkout works without encoding errors
- [ ] All security headers applied
- [ ] HTTPS redirects working