<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="LoveMeNow - User Profile Settings">
    <title>Profile Settings - LoveMeNow</title>

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="navbar-container">
            <!-- Logo Section -->
            <a class="navbar-brand" href="{{url_for('main.index')}}">
                <svg class="logo-icon" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                </svg>
                LoveMeNow
            </a>

            <!-- Main Navigation -->
            <div class="navbar-center">
                <ul class="nav-links">
                    <li><a class="nav-link" href="{{url_for('main.index')}}">Home</a></li>
                    <li><a class="nav-link" href="{{url_for('main.products')}}">Shop</a></li>
                    <li><a class="nav-link" href="{{url_for('main.about')}}">About</a></li>
                    <li><a class="nav-link" href="{{url_for('main.support')}}">Support</a></li>
                </ul>
            </div>

            <!-- Right Side Actions -->
            <div class="navbar-actions">
                <!-- Action Buttons -->
                <div class="nav-buttons">
                    <button type="button" onclick="openWishlistModal()" class="nav-icon-btn" title="Wishlist">
                        <i class="fas fa-heart"></i>
                        <span class="icon-badge" id="wishlistCount" style="display: none;">0</span>
                    </button>
                    <a href="#" class="nav-icon-btn" title="Cart">
                        <i class="fas fa-shopping-bag"></i>
                        <span class="icon-badge" id="cartCount">0</span>
                    </a>
                    {% if current_user.is_authenticated %}
                        <button class="btn btn-primary" id="userMenuButton">Account</button>
                    {% else %}
                        <button class="btn btn-primary" id="signInButton">Sign In</button>
                    {% endif %}
                </div>

                <!-- Mobile Menu Toggle -->
                <button class="mobile-menu-toggle">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
            </div>
        </div>
    </nav>

    <!-- Profile Header -->
    <section class="profile-header">
        <div class="container">
            <div class="profile-header-content">
                <div class="profile-avatar">
                    <div class="avatar-circle">
                        <i class="fas fa-user"></i>
                    </div>
                    <button class="avatar-edit-btn">
                        <i class="fas fa-camera"></i>
                    </button>
                </div>
                <div class="profile-info">
                    <h1>{{ current_user.full_name }}</h1>
                    <p class="profile-email">{{ current_user.email }}</p>
                    <p class="profile-member-since">{{ current_user.created_at }}</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Profile Content -->
    <div class="container profile-container">
        <div class="profile-layout">
            <!-- Profile Section -->
            <section class="profile-section">
                <div class="section-header">
                    <h2><i class="fas fa-user-circle"></i> Profile</h2>
                    <p class="section-description">Quick self-check: "Is this the right account?"</p>
                </div>
                <div class="section-content">
                    <div class="profile-snapshot">
                        <div class="form-group">
                            <label class="form-label">Display Name</label>
                            <input type="text" class="form-control" id="fullNameInput" value="{{ current_user.full_name }}" 
                                   onclick="makeEditable(this)" onblur="saveField(this, 'full_name')" 
                                   onkeypress="handleEnterKey(event, this, 'full_name')" readonly>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Primary Email</label>
                            <input type="email" class="form-control" id="emailInput" value="{{ current_user.email }}" 
                                   onclick="makeEditable(this)" onblur="saveField(this, 'email')" 
                                   onkeypress="handleEnterKey(event, this, 'email')" readonly>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Member Since</label>
                            <input type="text" class="form-control" value="{{ current_user.created_at }}" readonly>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Preferences Section -->
            <section class="profile-section">
                <div class="section-header">
                    <h2><i class="fas fa-cog"></i> Preferences</h2>
                    <p class="section-description">Personalisation & compliance</p>
                </div>
                <div class="section-content">
                    <div class="preferences-options">
                        <div class="preference-item">
                            <div class="preference-info">
                                <h3>Marketing Email Opt-in/out</h3>
                                <p>Receive promotional emails and offers</p>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" name="opt_in" value="1" 
                                       {{ 'checked' if current_user.marketing_opt_in else '' }}
                                       onchange="submitEmailToggle(this)">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>

                        <div class="preference-item">
                            <div class="preference-info">
                                <h3>Discreet Packaging Reminder</h3>
                                <p>Always use discreet packaging for orders</p>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" name="discreet_packaging" value="1"
                                       {{ 'checked' if current_user.discreet_packaging else '' }}
                                       onchange="submitDiscreetToggle(this)">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Contact & Shipping Section -->
            <section class="profile-section">
                <div class="section-header">
                    <h2><i class="fas fa-shipping-fast"></i> Contact & Shipping</h2>
                    <p class="section-description">Convenience at checkout</p>
                </div>
                <div class="section-content" id="add_address_div">
                    <div class="shipping-addresses">
                        <div class="address-header">
                            <h3>Shipping Addresses</h3>
                            <!-- ADDED data-modal attr (optional future use) -->
                            <button class="btn btn-primary btn-sm" id="addAddressButton" data-modal="addressModal">
                                <i class="fas fa-plus"></i> Add Address
                            </button>
                        </div>

                        <!-- Existing list (stays collapsed until you save one) -->
                        <div class="address-list hidden">
                            <!-- existing card template you already had -->
                            <div class="address-card">
                                <!-- your inline edit form ... unchanged ... -->
                                <!-- (kept as-is for reference, you can delete if redundant) -->
                            </div>
                        </div>
                    </div>
                </div>

                {% include "address_display.html" %}
            </section>


        </div>
    </div>

    {% include "change_password_modal.html" %}
    
    {# ░░░ AUTH MODALS ░░░ #}
    {% if not current_user.is_authenticated %}
        {% include "login_modal.html" %}
        {% include "register_modal.html" %}
    {% else %}
        {% include "logged_in_modal.html" %}
    {% endif %}
    
    {# ░░░ WISHLIST MODAL ░░░ #}
    {% include "wishlist_modal.html" %}

    <!-- ──────────────────────────────────────────────
         NEW ADD-ADDRESS MODAL
         ────────────────────────────────────────────── -->
    <div id="addressModal" class="modal-overlay" style="display:none">
        <div class="modal">
            <button class="modal-close">&times;</button>

            <form id="addressForm">
                <h3 class="modal-title"><i class="fas fa-map-marker-alt"></i> New address</h3>

                <div class="form-group">
                    <label for="new_addr1">Street address</label>
                    <input id="new_addr1" name="addr1" class="form-control" required>
                </div>

                <div class="form-group">
                    <label for="new_addr2">Apt / Suite / Floor (optional)</label>
                    <input id="new_addr2" name="addr2" class="form-control">
                </div>

                <div class="form-row triple">
                    <div class="form-group flex-2">
                        <label for="new_city">City</label>
                        <input id="new_city" name="city" class="form-control" required>
                    </div>
                    <div class="form-group flex-1">
                        <label for="new_state">State</label>
                        <input id="new_state" name="state" maxlength="2" class="form-control" required>
                    </div>
                    <div class="form-group flex-1">
                        <label for="new_zip">ZIP</label>
                        <input id="new_zip" name="zip" maxlength="10" class="form-control" required>
                    </div>
                </div>

                <div class="form-group">
                    <label for="new_country">Country</label>
                    <select id="new_country" name="country" class="form-control">
                        <option value="US">United States</option>
                        <option value="CA">Canada</option>
                        <option value="UK">United Kingdom</option>
                    </select>
                </div>

                <div class="form-group default-check">
                    <label><input type="checkbox" name="is_default"> Make default</label>
                </div>

                <div style="display:flex;gap:.75rem;margin-top:1.5rem">
                    <button type="submit" class="btn btn-primary btn-sm flex-1">Save</button>
                    <button type="button" id="cancelAddressBtn" class="btn btn-outline btn-sm flex-1">Cancel</button>
                </div>
            </form>
        </div>
    </div>
    <!-- ────────────────────────────────────────────── -->

    <!-- Global JS bundle -->
    <script src="{{ url_for('static', filename='JS/index.js') }}"></script>
    <!-- (the little add-address helper you pasted lives inside index.js now) -->
    
    <!-- Profile Editing Script -->
    <script>
        // Store original values for comparison
        let originalValues = {};
        
        function makeEditable(input) {
            // Store original value when first clicked
            if (!originalValues[input.id]) {
                originalValues[input.id] = input.value;
            }
            
            // Remove readonly and focus
            input.removeAttribute('readonly');
            input.focus();
            input.select();
            
            // Add visual indicator that it's editable
            input.style.borderColor = '#3b82f6';
            input.style.boxShadow = '0 0 0 2px rgba(59, 130, 246, 0.1)';
        }
        
        function saveField(input, fieldName) {
            const newValue = input.value.trim();
            const originalValue = originalValues[input.id];
            
            // If value hasn't changed, just make readonly again
            if (newValue === originalValue) {
                makeReadonly(input);
                return;
            }
            
            // If empty, revert to original
            if (!newValue) {
                input.value = originalValue;
                makeReadonly(input);
                showFlashMessage('❌ Field cannot be empty', 'danger');
                return;
            }
            
            // Save to database
            const data = {};
            data[fieldName] = newValue;
            
            fetch('/update_profile', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    // Update original value and make readonly
                    originalValues[input.id] = newValue;
                    makeReadonly(input);
                    showFlashMessage('✅ Profile updated successfully', 'success');
                    
                    // Update header if name was changed
                    if (fieldName === 'full_name') {
                        const headerName = document.querySelector('.profile-info h1');
                        if (headerName) {
                            headerName.textContent = newValue;
                        }
                    }
                } else {
                    // Revert to original value
                    input.value = originalValue;
                    makeReadonly(input);
                    showFlashMessage('❌ ' + (result.error || 'Failed to update'), 'danger');
                }
            })
            .catch(error => {
                // Revert to original value
                input.value = originalValue;
                makeReadonly(input);
                showFlashMessage('❌ Network error. Please try again.', 'danger');
            });
        }
        
        function handleEnterKey(event, input, fieldName) {
            if (event.key === 'Enter') {
                event.preventDefault();
                input.blur(); // This will trigger saveField
            }
        }
        
        function makeReadonly(input) {
            input.setAttribute('readonly', true);
            input.style.borderColor = '';
            input.style.boxShadow = '';
        }
        
        function showFlashMessage(message, category) {
            // Create toast stack if it doesn't exist
            let toastStack = document.getElementById('flashStack');
            if (!toastStack) {
                toastStack = document.createElement('div');
                toastStack.className = 'toast-stack';
                toastStack.id = 'flashStack';
                document.body.appendChild(toastStack);
            }
            
            // Create toast element
            const toast = document.createElement('div');
            toast.className = `toast toast-${category}`;
            
            // Create close button
            const closeBtn = document.createElement('button');
            closeBtn.className = 'flash_message_close';
            closeBtn.innerHTML = '<i class="fas fa-times"></i>';
            closeBtn.onclick = function() {
                toast.remove();
            };
            
            // Add content
            toast.appendChild(closeBtn);
            toast.appendChild(document.createTextNode(message));
            
            // Add to stack
            toastStack.appendChild(toast);
            
            // Auto remove after 4 seconds
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.remove();
                }
            }, 4000);
        }
    </script>
    
    <!-- Preferences Toggle Scripts -->
    <script>
        function submitEmailToggle(checkbox) {
            // Create FormData object
            const formData = new FormData();
            formData.append('opt_in', checkbox.checked ? '1' : '0');
            
            // Submit via fetch to avoid page reload
            fetch('/marketing', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (response.ok) {
                    // Show success message
                    if (checkbox.checked) {
                        showFlashMessage('✅ Subscribed to VIP emails! Welcome email sent.', 'success');
                    } else {
                        showFlashMessage('📧 Unsubscribed from marketing emails.', 'success');
                    }
                } else {
                    // If server error, revert the toggle
                    checkbox.checked = !checkbox.checked;
                    showFlashMessage('❌ Error updating preferences. Please try again.', 'danger');
                }
            })
            .catch(error => {
                // If network error, revert the toggle
                checkbox.checked = !checkbox.checked;
                showFlashMessage('❌ Network error. Please try again.', 'danger');
            });
        }

        function submitDiscreetToggle(checkbox) {
            // Create FormData object
            const formData = new FormData();
            formData.append('discreet_packaging', checkbox.checked ? '1' : '0');
            
            // Submit via fetch to avoid page reload
            fetch('/discreet_packaging', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (response.ok) {
                    // Show success message
                    if (checkbox.checked) {
                        showFlashMessage('📦 Discreet packaging enabled for all orders.', 'success');
                    } else {
                        showFlashMessage('📦 Standard packaging will be used.', 'success');
                    }
                } else {
                    // If server error, revert the toggle
                    checkbox.checked = !checkbox.checked;
                    showFlashMessage('❌ Error updating packaging preferences. Please try again.', 'danger');
                }
            })
            .catch(error => {
                // If network error, revert the toggle
                checkbox.checked = !checkbox.checked;
                showFlashMessage('❌ Network error. Please try again.', 'danger');
            });
        }
    </script>
</body>
</html>
